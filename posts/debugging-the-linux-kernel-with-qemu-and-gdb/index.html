<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Debugging the Linux Kernel with QEMU and GDB - yuankun@net: ~$</title><meta name=Description content="Always do what you're afraid to do"><meta property="og:title" content="Debugging the Linux Kernel with QEMU and GDB"><meta property="og:description" content="In the previous article, we explored how to run a raw Linux kernel in QEMU. Another fascinating feature that QEMU provides is to initiate a GDB server. An external GDB debugger can then connect to it. This means that we can suspend the kernel running at any point of the kernel startup. By leveraging this feature, we can construct an efficient environment to debug system kernels and firmware. In this guide, we will explore the process of using this feature to debug the Linux kernel."><meta property="og:type" content="article"><meta property="og:url" content="https://yuankun.me/posts/debugging-the-linux-kernel-with-qemu-and-gdb/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-20T09:31:33+08:00"><meta property="article:modified_time" content="2020-03-20T09:31:33+08:00"><meta property="og:site_name" content="yuankun@net: ~$"><meta name=twitter:card content="summary"><meta name=twitter:title content="Debugging the Linux Kernel with QEMU and GDB"><meta name=twitter:description content="In the previous article, we explored how to run a raw Linux kernel in QEMU. Another fascinating feature that QEMU provides is to initiate a GDB server. An external GDB debugger can then connect to it. This means that we can suspend the kernel running at any point of the kernel startup. By leveraging this feature, we can construct an efficient environment to debug system kernels and firmware. In this guide, we will explore the process of using this feature to debug the Linux kernel."><meta name=application-name content="yuankun@net: ~$"><meta name=apple-mobile-web-app-title content="yuankun@net: ~$"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://yuankun.me/posts/debugging-the-linux-kernel-with-qemu-and-gdb/><link rel=prev href=https://yuankun.me/posts/running-the-raw-linux-kernel-in-qemu/><link rel=next href=https://yuankun.me/posts/a-terraform-module-to-list-google-cloud-service-agents/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Debugging the Linux Kernel with QEMU and GDB","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yuankun.me\/posts\/debugging-the-linux-kernel-with-qemu-and-gdb\/"},"genre":"posts","keywords":"linux, qemu, gdb","wordcount":446,"url":"https:\/\/yuankun.me\/posts\/debugging-the-linux-kernel-with-qemu-and-gdb\/","datePublished":"2020-03-20T09:31:33+08:00","dateModified":"2020-03-20T09:31:33+08:00","publisher":{"@type":"Organization","name":"yuankun"},"author":{"@type":"Person","name":"yuankun"},"description":""}</script><script src=//instant.page/5.2.0 defer type=module integrity=sha384-jnZyxPjiipYXnSU0ygqeac2q7CVYMbh84q0uHVRRxEtvFPiQYbXWUorga2aqZJ0z></script></head><body header-desktop header-mobile><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else""==="light"||""==="dark"||""==="black"?(setTheme(""),saveTheme("")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="yuankun@net: ~$">yuankun@net: ~$</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Blog </a><a class=menu-item href=/about/>About </a><a class=menu-item href=/syscall64/>Linux x64 Syscalls </a><a class=menu-item href=/syscall32/>Linux x86 Syscalls </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="yuankun@net: ~$">yuankun@net: ~$</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Blog</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=/syscall64/ title>Linux x64 Syscalls</a><a class=menu-item href=/syscall32/ title>Linux x86 Syscalls</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","false")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Debugging the Linux Kernel with QEMU and GDB</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=/ title=Author rel=author class=author>yuankun</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-03-20>2020-03-20</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2020-03-20>2020-03-20</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;446 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;3 minutes&nbsp;</div></div><div class=content id=content><p>In the <a href=/posts/running-the-raw-linux-kernel-in-qemu/ rel>previous article</a>, we explored how to run a raw Linux kernel in QEMU. Another fascinating feature that QEMU provides is to initiate a GDB server. An external GDB debugger can then connect to it. This means that we can suspend the kernel running at any point of the kernel startup. By leveraging this feature, we can construct an efficient environment to debug system kernels and firmware. In this guide, we will explore the process of using this feature to debug the Linux kernel.</p><h2 id=compiling-the-kernel-with-debugging-information class=headerLink><a href=#compiling-the-kernel-with-debugging-information class=header-mark></a>Compiling the Kernel with Debugging Information</h2><p>The first step involves preparing a kernel embedded with debugging information. To achieve this, we enable the relavent kernel configurations:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ <span class=nb>cd</span> linux-source/
</span></span><span class=line><span class=cl>$ make menuconfig
</span></span></code></pre></div><p>Next, navigate to <code>Kernel hacking > Compile-time checks and compiler options</code>. Here, enable the following two options:</p><ul><li>Compile the kernel with debug info</li><li>Provide GDB scripts for kernel debugging</li></ul><p><figure><a class=lightgallery href=/img/provide-gdb-scripts-for-kernel-debugging.png title="Provide GDB scripts for kernel debugging" data-thumbnail=/img/provide-gdb-scripts-for-kernel-debugging.png><img loading=lazy src=/img/provide-gdb-scripts-for-kernel-debugging.png srcset="/img/provide-gdb-scripts-for-kernel-debugging.png, /img/provide-gdb-scripts-for-kernel-debugging.png 1.5x, /img/provide-gdb-scripts-for-kernel-debugging.png 2x" sizes=auto alt=/img/provide-gdb-scripts-for-kernel-debugging.png></a></figure></p><p>Once we&rsquo;ve made these changes, save the new configuration and initiate the kernel compilation by executing <code>make -j${nproc}</code>. Following the compilation, we are interested in the two newly created files:</p><ul><li>vmlinux: A statically linked executable file format of the Linux Kernel, packed with all debugging information.</li><li>scripts/gdb/vmlinux-gdb.py: The GDB script used for kernel debugging.</li></ul><p>To ensure that the GDB script loads every time we initiate the GDB Debugger, let&rsquo;s add it to the GDB init file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;add-auto-load-safe-path `pwd`/scripts/gdb/vmlinux-gdb.py&#34;</span> &gt;&gt; ~/.gdbinit
</span></span></code></pre></div><h2 id=initiating-debugging-session class=headerLink><a href=#initiating-debugging-session class=header-mark></a>Initiating Debugging Session</h2><p>When debugging, QEMU provides two significant options:</p><ul><li>The <code>-S</code> option stops the CPU at the startup, allowing the debugger to connect and facilitating debugging from the start.</li><li>The <code>-s</code> option initiates a GDB Server on port 1234. Consequently, we can connect the GDB Debugger we can connect to it using <code>target remote :1234</code>.</li></ul><p>Now let&rsquo;s boot the kernel with these options:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ qemu-system-x86_64 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -S <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -s <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -enable-kvm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -kernel bzImage <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -smp <span class=nv>cores</span><span class=o>=</span>1,threads<span class=o>=</span><span class=m>2</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -m <span class=m>1024</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -append <span class=s2>&#34;console=ttyS0 nokaslr selinux=0 debug&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -initrd initramfs.img <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -serial stdio <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -display none
</span></span></code></pre></div><p>At this stage, the process remains on hold, since we instructed QEMU to pause for the debugger by using the <code>-S</code> option.</p><p>Open another terminal window and start the GDB Debugger, then connect it to QEMU:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ gdb vmlinux
</span></span><span class=line><span class=cl>Type <span class=s2>&#34;apropos word&#34;</span> to search <span class=k>for</span> commands related to <span class=s2>&#34;word&#34;</span>...
</span></span><span class=line><span class=cl>Reading symbols from vmlinux...
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> target remote :1234
</span></span><span class=line><span class=cl>Remote debugging using :1234
</span></span><span class=line><span class=cl>0x000000000000fff0 in exception_stacks <span class=o>()</span>
</span></span></code></pre></div><p>Now we can set breakpoints and track the kernel&rsquo;s executing as if it were just a normal user process:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> b start_kernel
</span></span><span class=line><span class=cl>Note: breakpoints <span class=m>1</span> and <span class=m>2</span> also <span class=nb>set</span> at pc 0xffffffff829e0aa8.
</span></span><span class=line><span class=cl>Breakpoint <span class=m>3</span> at 0xffffffff829e0aa8: file init/main.c, line 786.
</span></span><span class=line><span class=cl><span class=o>(</span>gdb<span class=o>)</span> c
</span></span><span class=line><span class=cl>Continuing.
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>Thread <span class=m>1</span> hit Breakpoint 1, start_kernel <span class=o>()</span> at init/main.c:786
</span></span><span class=line><span class=cl><span class=m>786</span>     <span class=o>{</span>
</span></span><span class=line><span class=cl>...
</span></span></code></pre></div><h2 id=references class=headerLink><a href=#references class=header-mark></a>References</h2><ul><li><a href=https://en.wikibooks.org/wiki/QEMU/Debugging_with_QEMU target=_blank rel="noopener noreferrer">Debugging with QEMU</a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2020-03-20</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/linux/>linux</a>,&nbsp;<a href=/tags/qemu/>qemu</a>,&nbsp;<a href=/tags/gdb/>gdb</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/running-the-raw-linux-kernel-in-qemu/ class=prev rel=prev title="Running the Raw Linux Kernel in QEMU"><i class="fas fa-angle-left fa-fw"></i>Running the Raw Linux Kernel in QEMU</a>
<a href=/posts/a-terraform-module-to-list-google-cloud-service-agents/ class=next rel=next title="A Terraform Module to List Google Cloud Service Agents">A Terraform Module to List Google Cloud Service Agents<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.113.0">Hugo</a>&nbsp;|&nbsp;Theme - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.3.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer">yuankun</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"comment",lightTheme:"github-light",repo:"yuankunzhang/blog"}}}</script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZXQSK4ST20")</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-ZXQSK4ST20" async></script></div></body></html>