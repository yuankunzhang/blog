<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>The Cleanup Variable Attribute in GCC - yuankun@net: ~$</title><meta name=Description content="Always do what you're afraid to do"><meta property="og:title" content="The Cleanup Variable Attribute in GCC"><meta property="og:description" content="C++ has a powerful idiom called RAII (Resource Acquisition Is Initialization)[^1], although the name might leave something to be desired. The fundamental idea is to represent a resource by a local object, tying the resource&rsquo;s lifecycle to the lifecycle of the local object&rsquo; lifecycle. In other words, we could say the local object is the owner of the resource (Hmm, I smell something rusty here). The local object is responsible for releasing the resource in its destructor."><meta property="og:type" content="article"><meta property="og:url" content="https://yuankun.me/posts/the-cleanup-variable-attribute-in-gcc/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-06-06T19:59:32+08:00"><meta property="article:modified_time" content="2023-06-06T19:59:32+08:00"><meta property="og:site_name" content="yuankun@net: ~$"><meta name=twitter:card content="summary"><meta name=twitter:title content="The Cleanup Variable Attribute in GCC"><meta name=twitter:description content="C++ has a powerful idiom called RAII (Resource Acquisition Is Initialization)[^1], although the name might leave something to be desired. The fundamental idea is to represent a resource by a local object, tying the resource&rsquo;s lifecycle to the lifecycle of the local object&rsquo; lifecycle. In other words, we could say the local object is the owner of the resource (Hmm, I smell something rusty here). The local object is responsible for releasing the resource in its destructor."><meta name=application-name content="yuankun@net: ~$"><meta name=apple-mobile-web-app-title content="yuankun@net: ~$"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://yuankun.me/posts/the-cleanup-variable-attribute-in-gcc/><link rel=prev href=https://yuankun.me/posts/linux-syscall-table-generator/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"The Cleanup Variable Attribute in GCC","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yuankun.me\/posts\/the-cleanup-variable-attribute-in-gcc\/"},"genre":"posts","keywords":"c, gcc","wordcount":642,"url":"https:\/\/yuankun.me\/posts\/the-cleanup-variable-attribute-in-gcc\/","datePublished":"2023-06-06T19:59:32+08:00","dateModified":"2023-06-06T19:59:32+08:00","publisher":{"@type":"Organization","name":"yuankun"},"author":{"@type":"Person","name":"yuankun"},"description":""}</script><script src=//instant.page/5.2.0 defer type=module integrity=sha384-jnZyxPjiipYXnSU0ygqeac2q7CVYMbh84q0uHVRRxEtvFPiQYbXWUorga2aqZJ0z></script></head><body header-desktop header-mobile><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else""==="light"||""==="dark"||""==="black"?(setTheme(""),saveTheme("")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="yuankun@net: ~$">yuankun@net: ~$</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Blog </a><a class=menu-item href=/about/>About </a><a class=menu-item href=/syscall64/>Linux x64 Syscalls </a><a class=menu-item href=/syscall32/>Linux x86 Syscalls </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="yuankun@net: ~$">yuankun@net: ~$</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Blog</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=/syscall64/ title>Linux x64 Syscalls</a><a class=menu-item href=/syscall32/ title>Linux x86 Syscalls</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><article class="page single"><h1 class="single-title animate__animated animate__flipInX">The Cleanup Variable Attribute in GCC</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=/ title=Author rel=author class=author>yuankun</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2023-06-06>2023-06-06</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2023-06-06>2023-06-06</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;642 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;4 minutes&nbsp;</div></div><div class=content id=content><p>C++ has a powerful idiom called <a href=https://www.stroustrup.com/bs_faq2.html#finally target=_blank rel="noopener noreferrer">RAII</a> (Resource Acquisition Is Initialization)[^1], although the name might leave something to be desired. The fundamental idea is to represent a resource by a local object, tying the resource&rsquo;s lifecycle to the lifecycle of the local object&rsquo; lifecycle. In other words, we could say the local object is the <em>owner</em> of the resource (Hmm, I smell something rusty here). The local object is responsible for releasing the resource in its destructor. Once the local object goes out of its scope, the resource is released. This mechanism remains valid even in the event of an exception within the scope. This is one of my most wanted feature when I&rsquo;m programming in C. Without it, some error handling situations often lead to numerous <code>goto failure</code> statements, where the <code>failure</code> block is merely used for releasing resources in a carefully crafted sequence. Appearently, the C standard committee is discussing to add <a href=https://gustedt.wordpress.com/2020/12/14/a-defer-mechanism-for-c/ target=_blank rel="noopener noreferrer">a defer mechanism</a> to C, taking inspiration from the <code>defer</code> construct in Golang.</p><p>Today I learned that GCC has already provided the semantic through an extension called the <code>cleanup</code> variable attribute. The cleanup attribute allows us to define an auto variable with a cleanup handler that will be invoked when the auto variable goes out of score. The cleanup handler must take one parameter, which is a pointer to a type compatible with the variable. The return value of the function (if any) is ignored. Below is its syntax.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>void</span> <span class=nf>handler</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* cleanup logic */</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* Must be applied only on auto variables */</span>
</span></span><span class=line><span class=cl><span class=n>attribute</span> <span class=nf>__</span><span class=p>((</span><span class=nf>cleanup</span><span class=p>(</span><span class=n>handler</span><span class=p>)))</span> <span class=n>var</span><span class=p>;</span>
</span></span></code></pre></div><h2 id=usage class=headerLink><a href=#usage class=header-mark></a>Usage</h2><p>Here&rsquo;s tiny program that illustrates how to use the cleanup attribute. In the code, I&rsquo;ve added a switch, <code>USE_CLEANUP</code>, which can be toggled to activate or deactivate the application of the <code>cleanup</code> variable attribute. In the <code>foo</code> function, I&rsquo;ve initiated two pointers, <code>x</code> and <code>y</code>, to point to two int objects on the heap. Note that I didn&rsquo;t deallocate the two int objects in the <code>foo</code> function.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef USE_CLEANUP
</span></span></span><span class=line><span class=cl><span class=cp>#define CLEANUP __attribute__ ((cleanup(cleanup_func)))
</span></span></span><span class=line><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp>#define CLEANUP
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>cleanup_func</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[cleanup_func] value=%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=o>**</span><span class=p>(</span><span class=kt>int</span> <span class=o>**</span><span class=p>)</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>free</span><span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=kt>void</span> <span class=o>**</span><span class=p>)</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>foo</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>CLEANUP</span> <span class=kt>int</span> <span class=o>*</span><span class=n>x</span> <span class=o>=</span> <span class=nf>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=n>CLEANUP</span> <span class=kt>int</span> <span class=o>*</span><span class=n>y</span> <span class=o>=</span> <span class=nf>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>));</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=n>x</span> <span class=o>=</span> <span class=mi>42</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=o>*</span><span class=n>y</span> <span class=o>=</span> <span class=mi>39</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[foo] x=%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=o>*</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;[foo] y=%d</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=o>*</span><span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nf>foo</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Now, compile the program with the <code>-DUSE_CLEANUP</code> flag and run it. We see that the cleanup handler is invoked twice, in the reverse order of how we defined the two integer pointers.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=o>[</span>foo<span class=o>]</span> <span class=nv>x</span><span class=o>=</span><span class=m>42</span>
</span></span><span class=line><span class=cl><span class=o>[</span>foo<span class=o>]</span> <span class=nv>y</span><span class=o>=</span><span class=m>39</span>
</span></span><span class=line><span class=cl><span class=o>[</span>cleanup_func<span class=o>]</span> <span class=nv>value</span><span class=o>=</span><span class=m>39</span>
</span></span><span class=line><span class=cl><span class=o>[</span>cleanup_func<span class=o>]</span> <span class=nv>value</span><span class=o>=</span><span class=m>42</span>
</span></span></code></pre></div><h2 id=implementation class=headerLink><a href=#implementation class=header-mark></a>Implementation</h2><p>In order to implement the <code>cleanup</code> attribute, GCC inserts instructions to call the handler before returning from the current function. We can confirm this by comparing the two variants of the above program - one that compiled with the <code>-DUSE_CLEANUP</code> flag and another that does not. I&rsquo;ve turned off stack protector to avoid nay unrelated stack protection instructions.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ cc -DUSE_CLEANUP -fno-stack-protector -S -o with_cleanup.s main.c
</span></span><span class=line><span class=cl>$ cc -fno-stack-protector -S -o no_cleanup.s main.c
</span></span><span class=line><span class=cl>$ diff -y no_cleanup.s with_cleanup.s
</span></span></code></pre></div><p><figure><a class=lightgallery href=/img/cleanup-diff.png title=/img/cleanup-diff.png data-thumbnail=/img/cleanup-diff.png><img loading=lazy src=/img/cleanup-diff.png srcset="/img/cleanup-diff.png, /img/cleanup-diff.png 1.5x, /img/cleanup-diff.png 2x" sizes=auto alt=/img/cleanup-diff.png></a></figure></p><p>The diff result clearly shows that in the <code>-DUSE_CLEANUP</code> version, GCC generates instructions to call the cleanup handler twice at the termination of the <code>foo</code> function. That&rsquo;s the only distinction between the two versions.</p><p>From this implementation, we can draw a few insights:</p><ul><li>The cleanup handler won&rsquo;t be called if the local scope executes any of the <code>exit</code> functions or the <code>abort</code> function.</li><li>The cleanup handler might not be called or might not complete in the event of a terminate signal, depending on the timing of the signal reception.</li><li>The cleanup handler won&rsquo;t be called if the local scope performs a long jump instead of a normal return.</li></ul><p>Moreover, as per the <a href=https://gcc.gnu.org/onlinedocs/gcc/Common-Variable-Attributes.html target=_blank rel="noopener noreferrer">GCC documentation</a>, it is undefined what happens if the cleanup handler does not return normally (e.g., if it performs a long jump).</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2023-06-06</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/c/>c</a>,&nbsp;<a href=/tags/gcc/>gcc</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/linux-syscall-table-generator/ class=prev rel=prev title="Linux Syscall Table Generator"><i class="fas fa-angle-left fa-fw"></i>Linux Syscall Table Generator</a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.113.0">Hugo</a>&nbsp;|&nbsp;Theme - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.3.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer">yuankun</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"comment",lightTheme:"github-light",repo:"yuankunzhang/blog"}}}</script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZXQSK4ST20")</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-ZXQSK4ST20" async></script></div></body></html>