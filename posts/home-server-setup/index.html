<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Setup a Home Server | Yuankun's Blog</title><meta name=keywords content="linux,arch,luks,raid"><meta name=description content="Recently I got a retired computer. Better than letting it sit in the corner queitly and become a dust collector, I&rsquo;ve been planning to turn it into a home server. I mainly need a Samba Server, but I may go further to run other self-hosted services like NextCloud.
In this article I&rsquo;ll talk about my setup of this home server."><meta name=author content="Yuankun"><link rel=canonical href=https://yuankun.me/posts/home-server-setup/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://yuankun.me/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://yuankun.me/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://yuankun.me/favicon-32x32.png><link rel=apple-touch-icon href=https://yuankun.me/apple-touch-icon.png><link rel=mask-icon href=https://yuankun.me/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Setup a Home Server"><meta property="og:description" content="Recently I got a retired computer. Better than letting it sit in the corner queitly and become a dust collector, I&rsquo;ve been planning to turn it into a home server. I mainly need a Samba Server, but I may go further to run other self-hosted services like NextCloud.
In this article I&rsquo;ll talk about my setup of this home server."><meta property="og:type" content="article"><meta property="og:url" content="https://yuankun.me/posts/home-server-setup/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-06-21T20:50:45+08:00"><meta property="article:modified_time" content="2021-06-21T20:50:45+08:00"><meta property="og:site_name" content="Yuankun's Blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="Setup a Home Server"><meta name=twitter:description content="Recently I got a retired computer. Better than letting it sit in the corner queitly and become a dust collector, I&rsquo;ve been planning to turn it into a home server. I mainly need a Samba Server, but I may go further to run other self-hosted services like NextCloud.
In this article I&rsquo;ll talk about my setup of this home server."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://yuankun.me/posts/"},{"@type":"ListItem","position":3,"name":"Setup a Home Server","item":"https://yuankun.me/posts/home-server-setup/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Setup a Home Server","name":"Setup a Home Server","description":"Recently I got a retired computer. Better than letting it sit in the corner queitly and become a dust collector, I\u0026rsquo;ve been planning to turn it into a home server. I mainly need a Samba Server, but I may go further to run other self-hosted services like NextCloud.\nIn this article I\u0026rsquo;ll talk about my setup of this home server.\n","keywords":["linux","arch","luks","raid"],"articleBody":"Recently I got a retired computer. Better than letting it sit in the corner queitly and become a dust collector, I’ve been planning to turn it into a home server. I mainly need a Samba Server, but I may go further to run other self-hosted services like NextCloud.\nIn this article I’ll talk about my setup of this home server.\nOperating System I’ve been using Arch Linux as my desktop OS for a long time, and I’m loving it (and you should also try it). Though it’s rare to hear people using Arch Linux as server OS, I’d like to give it a try. I will maybe write a review after six months or one year of running it. There are some shining features that I love the most about Arch Linux:\nMinimal system out of the box. Arch Linux by default has almost nothing installed. You choose what to install. Rolling release. This is what other distros like Debian or CentOS are missing. Because of the rolling release model, my server will be always running the latest everything. Well, it may be a concern that this rolling release model is a bit too aggressive and may introduce unstable features. As I’m using it only for my home server, the risk is acceptable. Excellent Wiki. There are detailed guides on almost everything you want to do with your system. Kudos to the community! Hardware Here are my hardware components.\nMotherboard: Gigabyte B360M AORUS Gaming 3 CPU: Intel Core i5-8400 (6 cores, 12 threads) RAM: Vengeance LPX 8GB DDR4 DRAM 2400MHz x 4 (32GB in total) SSD: Samsung 980 PRO 1TB PCIe NVMe Gen4 SSD M.2 HDD: Seagate IronWolf 4TB x 2 GPU: Don’t have one, don’t need one for this server. Goals These are the goals I want to achieve with this server build.\nNo proprietary software. Except the boot firmware for now. I’ll give Libreboot a try later some time. Full disk encryption. Except the boot partition. Disk decryption via a remove SSH session. I don’t want to plug in a keyboard and a screen every time I need to restart the server. RAID 1 on the two HDDs. It will be used as the Samba storage partition. I’m not sure whether or not it’s worth to setup the SSD as a cache for the RAID. For now I’m excluding it from my goals. It will be an interesting investigation for future time.\nDisk Partitioning and Encryption Disk partitioning and encryption need to be done before the installation of the operating system.\nThe 1TB SSD are split into two partitions: 1GB of the EFI system partition (mounted at /boot); and the root partition taking up the rest of the SSD.\nDevice Start End Sectors Size Type /dev/nvme0n1p1 2048 2099199 2097152 1G EFI System /dev/nvme0n1p2 2099200 1953525134 1951425935 930.5G Linux filesystem The root partition is encrypted by dm-crypt.\n# Encrypt the root partition. $ cryptsetup luksFormat /dev/nvme0n1p2 # Open the encrypted root partition and mount it to /dev/mapper/root. $ cryptsetup open /dev/nvme0n1p2 root The two HDDs are implemented as software RAID (level 1). I’m using mdadm to manage it.\n$ mdadm --create --verbose --level=1 --metadata=1.2 --raid-devices=2 /dev/md0 /dev/sda1 /dev/sdb1 Here, /dev/md0 is the logical RAID block device. It is, in turn, encrypted by dm-crypt.\n# Encrypt the RAID block device. $ cryptsetup luksFormat /dev/md0 # Open the RAID block device and mount it to /dev/mapper/nas. $ cryptsetup open /dev/md0 nas Below is the final layout of my disks:\n$ lsblk NAME MAJ:MIN RM SIZE RO TYPE MOUNTPOINTS sda 8:0 0 3.6T 0 disk └─sda1 8:1 0 3.6T 0 part └─md0 9:0 0 3.6T 0 raid1 └─nas 254:1 0 3.6T 0 crypt /nas sdb 8:16 0 3.6T 0 disk └─sdb1 8:17 0 3.6T 0 part └─md0 9:0 0 3.6T 0 raid1 └─nas 254:1 0 3.6T 0 crypt /nas nvme0n1 259:0 0 931.5G 0 disk ├─nvme0n1p1 259:1 0 1G 0 part /boot └─nvme0n1p2 259:2 0 930.5G 0 part └─root 254:0 0 930.5G 0 crypt / Mdadm needs the mdadm_udev hook, so we should add it to the HOOKS section in /etc/mkinitcpio.conf:\nArch Linux Installation Follow this great Arch wiki to get the system installed.\nI’m using systemd-boot as the UEFI boot manager. The CFG Lock BIOS switch must be disabled. The installation is actually very straightforward:\nMount the EFI system partition at /boot. Run bootctl install to install systemd-boot. This will copy systemd-boot to the EFI partition, and then set systemd-boot as the default EFI boot entry loaded by the EFI Boot manager. Create the bootloader entry. Two files are needed: /boot/loader/loader.conf and /boot/loader/entries/arch.conf. $ cat \u003c /boot/loader/loader.conf default arch.conf timeout 3 console-mode max editor no EOF $ cat \u003c /boot/loader/entries/arch.conf title Arch Linux linux /vmlinuz-linux initrd /initramfs-linux.img options root=/dev/mapper/root EOF Root Partition Decryption and Mounting One of the goals is for me to be able to remote unlock the LUKS-encrypted root partition. There’s this mkinitcpio hook called systemd-tool. It provides early remote SSH access before the root partition gets mounted.\nFirst, install systemd-tool and its dependencies.\n$ pacman -S mkinitcpio-systemd-tool busybox cryptsetup openssh tinyssh tinyssh-convert mc It requires the systemd-tool hook. Add this hook in /etc/mkinitcpio.conf. The final HOOKS section in /etc/mkinitcpio.conf looks like below.\nHOOKS=(base udev autodetect modconf block mdadm_udev filesystems keyboard fsck systemd systemd-tool) After that, I need to configure /etc/crypttab and /etc/mkinitcpio-systemd-tool/config/crypttab.\n$ echo \"crypt UUID=$(blkid -s UUID -o value /dev/sdX2) none luks\" \u003e /etc/crypttab $ cat /etc/crypttab \u003e /etc/mkinitcpio-systemd-tool/config/crypttab As well as /etc/fstab and /etc/mkinitcpio-systemd-tool/config/fstab.\n$ echo \"UUID=$(blkid -s UUID -o value /dev/mapper/root) / ext4 rw,relatime 0 1\" \u003e /etc/fstab $ echo \"/dev/mapper/root /sysroot auto x-systemd.device-timeout=9999h 0 1\" \u003e /etc/mkinitcpio-systemd-tool/config/fstab Then, enable the required services and build initramfs.\n$ systemctl enable initrd-cryptsetup.path $ systemctl enable initrd-tinysshd $ systemctl enable initrd-debug-progs $ systemctl enable initrd-sysroot-mount $ mkinitcpio -P Remote Unlocking After rebooting, the server now has a fancy remote shell environment running before the root partition gets mounted. This allows me to connect to the server remotely. A few things to note about this remote shell though:\nThe shell is a tinyssh service. Tinyssh only recognizes Ed25519 SSH key. So I need to generate an Ed25519 key pair on my local machine and paste the public key to /root/.ssh/authorized_keys. In this early stage, we can only connect as root user, because other users are not available yet. The root partition will automatically get decrypted and mounted after the decryption key is typed into the prompt.\nI haven’t talked about the decryption and mounting of the RAID device. It is actually less a problem. We can simply create a key file under /etc/cryptsetup-keys.d/ (let’s call it nas.key) and use this key file to decrypt the RAID device. Modify /etc/crypttab and /etc/fstab as described below and we are all set.\n$ echo \"nas UUID=$(blkid -s UUID -o value /dev/md0) /etc/cryptsetup-keys.d/nas.key\" \u003e\u003e /etc/crypttab $ echo \"UUID=$(blkid -s UUID -o value /dev/mapper/nas) /nas ext4 rw,relatime 0 1\" \u003e\u003e /etc/fstab ","wordCount":"1149","inLanguage":"en","datePublished":"2021-06-21T20:50:45+08:00","dateModified":"2021-06-21T20:50:45+08:00","author":{"@type":"Person","name":"Yuankun"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://yuankun.me/posts/home-server-setup/"},"publisher":{"@type":"Organization","name":"Yuankun's Blog","logo":{"@type":"ImageObject","url":"https://yuankun.me/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://yuankun.me accesskey=h title="Yuankun's Blog (Alt + H)">Yuankun's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://yuankun.me/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://yuankun.me/archives/ title=Archives><span>Archives</span></a></li><li><a href=https://yuankun.me/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://yuankun.me/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://yuankun.me/about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://yuankun.me>Home</a>&nbsp;»&nbsp;<a href=https://yuankun.me/posts/>Posts</a></div><h1 class=post-title>Setup a Home Server</h1><div class=post-meta><span title='2021-06-21 20:50:45 +0800 +0800'>June 21, 2021</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1149 words&nbsp;·&nbsp;Yuankun</div></header><div class=post-content><p>Recently I got a retired computer. Better than letting it sit in the corner queitly and become a dust collector, I&rsquo;ve been planning to turn it into a home server. I mainly need a Samba Server, but I may go further to run other self-hosted services like NextCloud.</p><p>In this article I&rsquo;ll talk about my setup of this home server.</p><h2 id=operating-system>Operating System<a hidden class=anchor aria-hidden=true href=#operating-system>#</a></h2><p>I&rsquo;ve been using Arch Linux as my desktop OS for a long time, and I&rsquo;m loving it (<a href="https://bbs.archlinux.org/viewtopic.php?id=115942">and you should also try it</a>). Though it&rsquo;s rare to hear people using Arch Linux as server OS, I&rsquo;d like to give it a try. I will maybe write a review after six months or one year of running it. There are some shining features that I love the most about Arch Linux:</p><ul><li><strong>Minimal system out of the box</strong>. Arch Linux by default has almost nothing installed. You choose what to install.</li><li><strong>Rolling release</strong>. This is what other distros like Debian or CentOS are missing. Because of the rolling release model, my server will be always running the latest everything. Well, it may be a concern that this rolling release model is a bit too aggressive and may introduce unstable features. As I&rsquo;m using it only for my home server, the risk is acceptable.</li><li><strong>Excellent Wiki</strong>. There are detailed guides on almost everything you want to do with your system. Kudos to the community!</li></ul><p><img loading=lazy src=/img/linux-rolling-release-model.png.webp alt="The Linux Rolling Relase Model - https://www.maketecheasier.com/linux-rolling-release-model/"></p><h2 id=hardware>Hardware<a hidden class=anchor aria-hidden=true href=#hardware>#</a></h2><p>Here are my hardware components.</p><ul><li>Motherboard: Gigabyte B360M AORUS Gaming 3</li><li>CPU: Intel Core i5-8400 (6 cores, 12 threads)</li><li>RAM: Vengeance LPX 8GB DDR4 DRAM 2400MHz x 4 (32GB in total)</li><li>SSD: Samsung 980 PRO 1TB PCIe NVMe Gen4 SSD M.2</li><li>HDD: Seagate IronWolf 4TB x 2</li><li>GPU: Don&rsquo;t have one, don&rsquo;t need one for this server.</li></ul><h2 id=goals>Goals<a hidden class=anchor aria-hidden=true href=#goals>#</a></h2><p>These are the goals I want to achieve with this server build.</p><ul><li><strong>No proprietary software</strong>. Except the boot firmware for now. I&rsquo;ll give <a href=https://libreboot.org/>Libreboot</a> a try later some time.</li><li><strong>Full disk encryption</strong>. Except the boot partition.</li><li><strong>Disk decryption via a remove SSH session</strong>. I don&rsquo;t want to plug in a keyboard and a screen every time I need to restart the server.</li><li><strong>RAID 1 on the two HDDs</strong>. It will be used as the Samba storage partition.</li></ul><p>I&rsquo;m not sure whether or not it&rsquo;s worth to setup the SSD as a cache for the RAID. For now I&rsquo;m excluding it from my goals. It will be an interesting investigation for future time.</p><h2 id=disk-partitioning-and-encryption>Disk Partitioning and Encryption<a hidden class=anchor aria-hidden=true href=#disk-partitioning-and-encryption>#</a></h2><p><img loading=lazy src=https://gitlab.com/cryptsetup/cryptsetup/wikis/luks-logo.png alt></p><p>Disk partitioning and encryption need to be done before the installation of the operating system.</p><p>The 1TB SSD are split into two partitions: 1GB of the EFI system partition (mounted at <code>/boot</code>); and the root partition taking up the rest of the SSD.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>Device           Start        End    Sectors   Size Type
</span></span><span class=line><span class=cl>/dev/nvme0n1p1    <span class=m>2048</span>    <span class=m>2099199</span>    <span class=m>2097152</span>     1G EFI System
</span></span><span class=line><span class=cl>/dev/nvme0n1p2 <span class=m>2099200</span> <span class=m>1953525134</span> <span class=m>1951425935</span> 930.5G Linux filesystem
</span></span></code></pre></div><p>The root partition is encrypted by <a href=https://wiki.archlinux.org/title/Dm-crypt>dm-crypt</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Encrypt the root partition.</span>
</span></span><span class=line><span class=cl>$ cryptsetup luksFormat /dev/nvme0n1p2
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Open the encrypted root partition and mount it to /dev/mapper/root.</span>
</span></span><span class=line><span class=cl>$ cryptsetup open /dev/nvme0n1p2 root
</span></span></code></pre></div><p>The two HDDs are implemented as software RAID (level 1). I&rsquo;m using <a href=https://wiki.archlinux.org/title/RAID#Installation>mdadm</a> to manage it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ mdadm --create --verbose --level<span class=o>=</span><span class=m>1</span> --metadata<span class=o>=</span>1.2 --raid-devices<span class=o>=</span><span class=m>2</span> /dev/md0 /dev/sda1 /dev/sdb1
</span></span></code></pre></div><p>Here, <code>/dev/md0</code> is the logical RAID block device. It is, in turn, encrypted by dm-crypt.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=c1># Encrypt the RAID block device.</span>
</span></span><span class=line><span class=cl>$ cryptsetup luksFormat /dev/md0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Open the RAID block device and mount it to /dev/mapper/nas.</span>
</span></span><span class=line><span class=cl>$ cryptsetup open /dev/md0 nas
</span></span></code></pre></div><p>Below is the final layout of my disks:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ lsblk
</span></span><span class=line><span class=cl>NAME        MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINTS
</span></span><span class=line><span class=cl>sda           8:0    <span class=m>0</span>   3.6T  <span class=m>0</span> disk
</span></span><span class=line><span class=cl>└─sda1        8:1    <span class=m>0</span>   3.6T  <span class=m>0</span> part
</span></span><span class=line><span class=cl>  └─md0       9:0    <span class=m>0</span>   3.6T  <span class=m>0</span> raid1
</span></span><span class=line><span class=cl>    └─nas   254:1    <span class=m>0</span>   3.6T  <span class=m>0</span> crypt /nas
</span></span><span class=line><span class=cl>sdb           8:16   <span class=m>0</span>   3.6T  <span class=m>0</span> disk
</span></span><span class=line><span class=cl>└─sdb1        8:17   <span class=m>0</span>   3.6T  <span class=m>0</span> part
</span></span><span class=line><span class=cl>  └─md0       9:0    <span class=m>0</span>   3.6T  <span class=m>0</span> raid1
</span></span><span class=line><span class=cl>    └─nas   254:1    <span class=m>0</span>   3.6T  <span class=m>0</span> crypt /nas
</span></span><span class=line><span class=cl>nvme0n1     259:0    <span class=m>0</span> 931.5G  <span class=m>0</span> disk
</span></span><span class=line><span class=cl>├─nvme0n1p1 259:1    <span class=m>0</span>     1G  <span class=m>0</span> part  /boot
</span></span><span class=line><span class=cl>└─nvme0n1p2 259:2    <span class=m>0</span> 930.5G  <span class=m>0</span> part
</span></span><span class=line><span class=cl>  └─root    254:0    <span class=m>0</span> 930.5G  <span class=m>0</span> crypt /
</span></span></code></pre></div><p>Mdadm needs the <code>mdadm_udev</code> hook, so we should add it to the <code>HOOKS</code> section in <code>/etc/mkinitcpio.conf</code>:</p><h2 id=arch-linux-installation>Arch Linux Installation<a hidden class=anchor aria-hidden=true href=#arch-linux-installation>#</a></h2><p>Follow <a href=https://wiki.archlinux.org/title/installation_guide>this great Arch wiki</a> to get the system installed.</p><p>I&rsquo;m using <a href=https://wiki.archlinux.org/title/Systemd-boot>systemd-boot</a> as the UEFI boot manager. The <code>CFG Lock</code> BIOS switch must be disabled. The installation is actually very straightforward:</p><ol><li>Mount the EFI system partition at <code>/boot</code>.</li><li>Run <code>bootctl install</code> to install systemd-boot. This will copy systemd-boot to the EFI partition, and then set systemd-boot as the default EFI boot entry loaded by the EFI Boot manager.</li><li>Create the bootloader entry. Two files are needed: <code>/boot/loader/loader.conf</code> and <code>/boot/loader/entries/arch.conf</code>.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ cat <span class=s>&lt;&lt;EOF &gt; /boot/loader/loader.conf
</span></span></span><span class=line><span class=cl><span class=s>default arch.conf
</span></span></span><span class=line><span class=cl><span class=s>timeout 3
</span></span></span><span class=line><span class=cl><span class=s>console-mode max
</span></span></span><span class=line><span class=cl><span class=s>editor no
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ cat <span class=s>&lt;&lt;EOF &gt; /boot/loader/entries/arch.conf
</span></span></span><span class=line><span class=cl><span class=s>title Arch Linux
</span></span></span><span class=line><span class=cl><span class=s>linux /vmlinuz-linux
</span></span></span><span class=line><span class=cl><span class=s>initrd /initramfs-linux.img
</span></span></span><span class=line><span class=cl><span class=s>options root=/dev/mapper/root
</span></span></span><span class=line><span class=cl><span class=s>EOF</span>
</span></span></code></pre></div><h2 id=root-partition-decryption-and-mounting>Root Partition Decryption and Mounting<a hidden class=anchor aria-hidden=true href=#root-partition-decryption-and-mounting>#</a></h2><p>One of the goals is for me to be able to remote unlock the LUKS-encrypted root partition. There&rsquo;s this mkinitcpio hook called <a href=https://github.com/random-archer/mkinitcpio-systemd-tool>systemd-tool</a>. It provides early remote SSH access before the root partition gets mounted.</p><p>First, install systemd-tool and its dependencies.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ pacman -S mkinitcpio-systemd-tool busybox cryptsetup openssh tinyssh tinyssh-convert mc
</span></span></code></pre></div><p>It requires the <code>systemd-tool</code> hook. Add this hook in <code>/etc/mkinitcpio.conf</code>. The final <code>HOOKS</code> section in <code>/etc/mkinitcpio.conf</code> looks like below.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>HOOKS=(base udev autodetect modconf block mdadm_udev filesystems keyboard fsck systemd systemd-tool)
</span></span></code></pre></div><p>After that, I need to configure <code>/etc/crypttab</code> and <code>/etc/mkinitcpio-systemd-tool/config/crypttab</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;crypt UUID=</span><span class=k>$(</span>blkid -s UUID -o value /dev/sdX2<span class=k>)</span><span class=s2> none luks&#34;</span> &gt; /etc/crypttab
</span></span><span class=line><span class=cl>$ cat /etc/crypttab &gt; /etc/mkinitcpio-systemd-tool/config/crypttab
</span></span></code></pre></div><p>As well as <code>/etc/fstab</code> and <code>/etc/mkinitcpio-systemd-tool/config/fstab</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;UUID=</span><span class=k>$(</span>blkid -s UUID -o value /dev/mapper/root<span class=k>)</span><span class=s2> /   ext4    rw,relatime 0 1&#34;</span> &gt; /etc/fstab
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;/dev/mapper/root    /sysroot    auto    x-systemd.device-timeout=9999h  0 1&#34;</span> &gt; /etc/mkinitcpio-systemd-tool/config/fstab
</span></span></code></pre></div><p>Then, enable the required services and build initramfs.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ systemctl <span class=nb>enable</span> initrd-cryptsetup.path
</span></span><span class=line><span class=cl>$ systemctl <span class=nb>enable</span> initrd-tinysshd
</span></span><span class=line><span class=cl>$ systemctl <span class=nb>enable</span> initrd-debug-progs
</span></span><span class=line><span class=cl>$ systemctl <span class=nb>enable</span> initrd-sysroot-mount
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>$ mkinitcpio -P
</span></span></code></pre></div><h2 id=remote-unlocking>Remote Unlocking<a hidden class=anchor aria-hidden=true href=#remote-unlocking>#</a></h2><p>After rebooting, the server now has a fancy remote shell environment running before the root partition gets mounted. This allows me to connect to the server remotely. A few things to note about this remote shell though:</p><ul><li>The shell is a tinyssh service.</li><li>Tinyssh only recognizes Ed25519 SSH key. So I need to generate an Ed25519 key pair on my local machine and paste the public key to <code>/root/.ssh/authorized_keys</code>.</li><li>In this early stage, we can only connect as <code>root</code> user, because other users are not available yet.</li></ul><p>The root partition will automatically get decrypted and mounted after the decryption key is typed into the prompt.</p><p>I haven&rsquo;t talked about the decryption and mounting of the RAID device. It is actually less a problem. We can simply create a key file under <code>/etc/cryptsetup-keys.d/</code> (let&rsquo;s call it <code>nas.key</code>) and use this key file to decrypt the RAID device. Modify <code>/etc/crypttab</code> and <code>/etc/fstab</code> as described below and we are all set.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;nas UUID=</span><span class=k>$(</span>blkid -s UUID -o value /dev/md0<span class=k>)</span><span class=s2> /etc/cryptsetup-keys.d/nas.key&#34;</span> &gt;&gt; /etc/crypttab
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;UUID=</span><span class=k>$(</span>blkid -s UUID -o value /dev/mapper/nas<span class=k>)</span><span class=s2> /nas   ext4    rw,relatime 0 1&#34;</span> &gt;&gt; /etc/fstab
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://yuankun.me/tags/linux/>linux</a></li><li><a href=https://yuankun.me/tags/arch/>arch</a></li><li><a href=https://yuankun.me/tags/luks/>luks</a></li><li><a href=https://yuankun.me/tags/raid/>raid</a></li></ul><nav class=paginav><a class=prev href=https://yuankun.me/posts/dev-machine-setup/><span class=title>« Prev</span><br><span>Setup a Development Machine</span></a>
<a class=next href=https://yuankun.me/posts/a-terraform-module-to-list-google-cloud-service-agents/><span class=title>Next »</span><br><span>A Terraform Module to List Google Cloud Service Agents</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Setup a Home Server on twitter" href="https://twitter.com/intent/tweet/?text=Setup%20a%20Home%20Server&url=https%3a%2f%2fyuankun.me%2fposts%2fhome-server-setup%2f&hashtags=linux%2carch%2cluks%2craid"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Setup a Home Server on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fyuankun.me%2fposts%2fhome-server-setup%2f&title=Setup%20a%20Home%20Server&summary=Setup%20a%20Home%20Server&source=https%3a%2f%2fyuankun.me%2fposts%2fhome-server-setup%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Setup a Home Server on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fyuankun.me%2fposts%2fhome-server-setup%2f&title=Setup%20a%20Home%20Server"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Setup a Home Server on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fyuankun.me%2fposts%2fhome-server-setup%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Setup a Home Server on whatsapp" href="https://api.whatsapp.com/send?text=Setup%20a%20Home%20Server%20-%20https%3a%2f%2fyuankun.me%2fposts%2fhome-server-setup%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Setup a Home Server on telegram" href="https://telegram.me/share/url?text=Setup%20a%20Home%20Server&url=https%3a%2f%2fyuankun.me%2fposts%2fhome-server-setup%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer><script src=https://utteranc.es/client.js repo=yuankunzhang/blog issue-term=pathname theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>&copy; 2022 <a href=https://yuankun.me>Yuankun's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>