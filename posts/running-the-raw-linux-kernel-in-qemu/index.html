<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Running the Raw Linux Kernel in QEMU - yuankun@net: ~$</title><meta name=Description content="Always do what you're afraid to do"><meta property="og:title" content="Running the Raw Linux Kernel in QEMU"><meta property="og:description" content="In the previous post we learned how to run a packaged Linux distribution in QEMU. This time, let&rsquo;s explore running a raw Linux kernel in QEMU."><meta property="og:type" content="article"><meta property="og:url" content="https://yuankun.me/posts/running-the-raw-linux-kernel-in-qemu/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-16T22:50:52+08:00"><meta property="article:modified_time" content="2020-03-16T22:50:52+08:00"><meta property="og:site_name" content="yuankun@net: ~$"><meta name=twitter:card content="summary"><meta name=twitter:title content="Running the Raw Linux Kernel in QEMU"><meta name=twitter:description content="In the previous post we learned how to run a packaged Linux distribution in QEMU. This time, let&rsquo;s explore running a raw Linux kernel in QEMU."><meta name=application-name content="yuankun@net: ~$"><meta name=apple-mobile-web-app-title content="yuankun@net: ~$"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://yuankun.me/posts/running-the-raw-linux-kernel-in-qemu/><link rel=prev href=https://yuankun.me/posts/a-guide-on-running-alpine-linux-in-qemu/><link rel=next href=https://yuankun.me/posts/debugging-the-linux-kernel-with-qemu-and-gdb/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Running the Raw Linux Kernel in QEMU","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yuankun.me\/posts\/running-the-raw-linux-kernel-in-qemu\/"},"genre":"posts","keywords":"linux, qemu","wordcount":704,"url":"https:\/\/yuankun.me\/posts\/running-the-raw-linux-kernel-in-qemu\/","datePublished":"2020-03-16T22:50:52+08:00","dateModified":"2020-03-16T22:50:52+08:00","publisher":{"@type":"Organization","name":"yuankun"},"author":{"@type":"Person","name":"yuankun"},"description":""}</script><script src=//instant.page/5.2.0 defer type=module integrity=sha384-jnZyxPjiipYXnSU0ygqeac2q7CVYMbh84q0uHVRRxEtvFPiQYbXWUorga2aqZJ0z></script></head><body header-desktop header-mobile><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else""==="light"||""==="dark"||""==="black"?(setTheme(""),saveTheme("")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="yuankun@net: ~$">yuankun@net: ~$</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Blog </a><a class=menu-item href=/about/>About </a><a class=menu-item href=/syscall64/>Linux x64 Syscalls </a><a class=menu-item href=/syscall32/>Linux x86 Syscalls </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="yuankun@net: ~$">yuankun@net: ~$</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Blog</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=/syscall64/ title>Linux x64 Syscalls</a><a class=menu-item href=/syscall32/ title>Linux x86 Syscalls</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Running the Raw Linux Kernel in QEMU</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=/ title=Author rel=author class=author>yuankun</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-03-16>2020-03-16</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2020-03-16>2020-03-16</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;704 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;4 minutes&nbsp;</div></div><div class=content id=content><p>In the <a href=/posts/a-guide-on-running-alpine-linux-in-qemu/ rel>previous post</a> we learned how to run a packaged Linux distribution in QEMU. This time, let&rsquo;s explore running a raw Linux kernel in QEMU.</p><h2 id=a-brief-introduction-to-initial-ramdisk class=headerLink><a href=#a-brief-introduction-to-initial-ramdisk class=header-mark></a>A Brief Introduction to Initial Ramdisk</h2><p>Many Linux distributions ship a small, generic kernel image. The device drivers are included as loadable kernel modules and stored in file system, it is just not practical to include all the device drivers in the kernel image itself. On my machine, the size of <code>vmlinuz-linux</code> is only 6.3 megabytes:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ls -lh /boot/vmlinuz-linux
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> root root 6.3M Mar <span class=m>15</span> 21:30 /boot/vmlinuz-linux
</span></span></code></pre></div><p>This presents a challenge of detecting and loading the necessary modules to mount the root file system during boot time. It&rsquo;s a chicken-and-egg problem. Additionally, the root file system may require special preparations to mount, such as being on an encrypted partition.</p><p>To address these challenges, the initial ramdisk comes into play as a temporary, RAM-based root file system. It contains user-space utilities that detect hardwares, descover devices, load necessary modules, and mount the actual root file system. Once it is loaded into memory, a simple yet sufficient environment is set up for the Linux kernel to complete the boot process. This environment is often called &ldquo;early user space&rdquo;.</p><p>On my machine, the initial ramdisk image is located in the boot partition with the name <code>initramfs-linux.img</code>. Not surprisingly, it is larger than the Linux kernel image itself:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ls -lh /boot/initramfs-linux.img
</span></span><span class=line><span class=cl>-rw-r--r-- <span class=m>1</span> root root 9.4M Mar <span class=m>15</span> 21:30 /boot/initramfs-linux.img
</span></span></code></pre></div><p>We can examine the contents of the image by using command <code>lsinitcpio /boot/initramfs-linux.img</code>. Indeed, it contains a simplified root system with various helper tools:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ lsinitcpio /boot/initramfs-linux.img
</span></span><span class=line><span class=cl>bin
</span></span><span class=line><span class=cl>buildconfig
</span></span><span class=line><span class=cl>config
</span></span><span class=line><span class=cl>dev/
</span></span><span class=line><span class=cl>etc/
</span></span><span class=line><span class=cl>etc/fstab
</span></span><span class=line><span class=cl>etc/initrd-release
</span></span><span class=line><span class=cl>etc/ld.so.cache
</span></span><span class=line><span class=cl>etc/ld.so.conf
</span></span><span class=line><span class=cl>etc/modprobe.d/
</span></span><span class=line><span class=cl>etc/mtab
</span></span><span class=line><span class=cl>hooks/
</span></span><span class=line><span class=cl>hooks/udev
</span></span><span class=line><span class=cl>init
</span></span><span class=line><span class=cl>init_functions
</span></span><span class=line><span class=cl>lib
</span></span><span class=line><span class=cl>lib64
</span></span><span class=line><span class=cl>new_root/
</span></span><span class=line><span class=cl>proc/
</span></span><span class=line><span class=cl>run/
</span></span><span class=line><span class=cl>sbin
</span></span><span class=line><span class=cl>sys/
</span></span><span class=line><span class=cl>tmp/
</span></span><span class=line><span class=cl>usr/
</span></span><span class=line><span class=cl>usr/bin/
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>var/
</span></span><span class=line><span class=cl>var/run
</span></span><span class=line><span class=cl>VERSION
</span></span></code></pre></div><h2 id=creating-an-initial-ramdisk class=headerLink><a href=#creating-an-initial-ramdisk class=header-mark></a>Creating an Initial Ramdisk</h2><p>The command to create an initial ramdisk in Arch Linux <code>mkinitcpio</code>, but it may defer in other distributions.</p><p>Quoting from the <code>mkinitcpio</code> manual page:</p><blockquote><p>(mkinitcpio) creates an initial ramdisk environment for booting the Linux kernel. The initial ramdisk is in essence a very small environment (early userspace) which loads various kernel modules and sets up necessary things before handing over control to init. This makes it possible to have, for example, encrypted root filesystems and root filesystems on a software RAID array. mkinitcpio allows for easy extension with custom hooks, has autodetection at runtime, and many other features.</p></blockquote><p>Let&rsquo;s proceed with creating the initial ramdisk.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ mkinitcpio -g initramfs.img
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Starting build: 5.5.9-arch1-2
</span></span><span class=line><span class=cl>  -&gt; Running build hook: <span class=o>[</span>base<span class=o>]</span>
</span></span><span class=line><span class=cl>  -&gt; Running build hook: <span class=o>[</span>udev<span class=o>]</span>
</span></span><span class=line><span class=cl>  -&gt; Running build hook: <span class=o>[</span>autodetect<span class=o>]</span>
</span></span><span class=line><span class=cl>  -&gt; Running build hook: <span class=o>[</span>modconf<span class=o>]</span>
</span></span><span class=line><span class=cl>  -&gt; Running build hook: <span class=o>[</span>block<span class=o>]</span>
</span></span><span class=line><span class=cl>  -&gt; Running build hook: <span class=o>[</span>filesystems<span class=o>]</span>
</span></span><span class=line><span class=cl>  -&gt; Running build hook: <span class=o>[</span>keyboard<span class=o>]</span>
</span></span><span class=line><span class=cl>  -&gt; Running build hook: <span class=o>[</span>fsck<span class=o>]</span>
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Generating module <span class=nv>dependencies</span>
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Creating gzip-compressed initcpio image: /home/yuankun/qemu-test/initramfs.img
</span></span><span class=line><span class=cl><span class=o>==</span>&gt; Image generation successful
</span></span></code></pre></div><h2 id=configuring-and-building-the-linux-kernel class=headerLink><a href=#configuring-and-building-the-linux-kernel class=header-mark></a>Configuring and Building the Linux Kernel</h2><p>Clone the Linux source code, and configure the Linux kernel with <code>make ARCH=x86_64 menuconfig</code>.</p><p><figure><a class=lightgallery href=/img/linux-menuconfig.png title=Menuconfig data-thumbnail=/img/linux-menuconfig.png><img loading=lazy src=/img/linux-menuconfig.png srcset="/img/linux-menuconfig.png, /img/linux-menuconfig.png 1.5x, /img/linux-menuconfig.png 2x" sizes=auto alt=/img/linux-menuconfig.png></a></figure></p><p>Save the configurations and exit the configuration interface, now let&rsquo;s compile the kernel image. The compiled kernel image will be located at <code>arch/x86/boot/bzImage</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ make -j<span class=sb>`</span>nproc<span class=sb>`</span>
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl>Setup is <span class=m>13820</span> bytes <span class=o>(</span>padded to <span class=m>13824</span> bytes<span class=o>)</span>.
</span></span><span class=line><span class=cl>System is <span class=m>8801</span> kB
</span></span><span class=line><span class=cl>CRC 52c54fbc
</span></span><span class=line><span class=cl>Kernel: arch/x86/boot/bzImage is ready  <span class=o>(</span><span class=c1>#2)</span>
</span></span></code></pre></div><h2 id=booting-the-linux-kernel-in-qemu class=headerLink><a href=#booting-the-linux-kernel-in-qemu class=header-mark></a>Booting the Linux Kernel in QEMU</h2><p>Now that we have both the Kernel image and the initial ramdisk, it&rsquo;s time to boot the Linux kernel in QEMU.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ qemu-system-x86_64 <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -enable-kvm <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -kernel bzImage <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -smp <span class=nv>cores</span><span class=o>=</span>1,threads<span class=o>=</span><span class=m>2</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -m <span class=m>1024</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -append <span class=s2>&#34;console=ttyS0&#34;</span> <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -initrd initramfs.img <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -serial stdio <span class=se>\
</span></span></span><span class=line><span class=cl><span class=se></span>    -display none
</span></span><span class=line><span class=cl><span class=o>[</span>    0.000000<span class=o>]</span> Linux version 5.6.0-rc6+ <span class=o>(</span>yuankun@mars<span class=o>)</span> <span class=o>(</span>gcc version 9.3.0 <span class=o>(</span>Arch Linux 9.3.0-1<span class=o>))</span> <span class=c1>#2 SMP Tue Mar 17 17:42:13 +08 2020</span>
</span></span><span class=line><span class=cl><span class=o>[</span>    0.000000<span class=o>]</span> Command line: <span class=nv>console</span><span class=o>=</span>ttyS0
</span></span><span class=line><span class=cl><span class=o>[</span>    0.000000<span class=o>]</span> x86/fpu: x87 FPU will use FXSAVE
</span></span><span class=line><span class=cl><span class=o>[</span>    0.000000<span class=o>]</span> BIOS-provided physical RAM map:
</span></span><span class=line><span class=cl><span class=o>[</span>    0.000000<span class=o>]</span> BIOS-e820: <span class=o>[</span>mem 0x0000000000000000-0x000000000009fbff<span class=o>]</span> usable
</span></span><span class=line><span class=cl><span class=o>[</span>    0.000000<span class=o>]</span> BIOS-e820: <span class=o>[</span>mem 0x000000000009fc00-0x000000000009ffff<span class=o>]</span> reserved
</span></span><span class=line><span class=cl><span class=o>[</span>    0.000000<span class=o>]</span> BIOS-e820: <span class=o>[</span>mem 0x00000000000f0000-0x00000000000fffff<span class=o>]</span> reserved
</span></span><span class=line><span class=cl><span class=o>[</span>    0.000000<span class=o>]</span> BIOS-e820: <span class=o>[</span>mem 0x0000000000100000-0x000000007ffdffff<span class=o>]</span> usable
</span></span><span class=line><span class=cl><span class=o>[</span>    0.000000<span class=o>]</span> BIOS-e820: <span class=o>[</span>mem 0x000000007ffe0000-0x000000007fffffff<span class=o>]</span> reserved
</span></span><span class=line><span class=cl><span class=o>[</span>    0.000000<span class=o>]</span> BIOS-e820: <span class=o>[</span>mem 0x00000000feffc000-0x00000000feffffff<span class=o>]</span> reserved
</span></span><span class=line><span class=cl><span class=o>[</span>    0.000000<span class=o>]</span> BIOS-e820: <span class=o>[</span>mem 0x00000000fffc0000-0x00000000ffffffff<span class=o>]</span> reserved
</span></span><span class=line><span class=cl><span class=o>[</span>    0.000000<span class=o>]</span> NX <span class=o>(</span>Execute Disable<span class=o>)</span> protection: active
</span></span><span class=line><span class=cl><span class=o>[</span>    0.000000<span class=o>]</span> SMBIOS 2.8 present.
</span></span><span class=line><span class=cl>...
</span></span><span class=line><span class=cl><span class=o>[</span>rootfs <span class=o>]</span><span class=c1>#</span>
</span></span></code></pre></div><p>You will soon see the <code>[rootfs] #</code> prompt, indicating that we are now in the environment provided by the initial ramdisk. Cheers!</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2020-03-16</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/linux/>linux</a>,&nbsp;<a href=/tags/qemu/>qemu</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/a-guide-on-running-alpine-linux-in-qemu/ class=prev rel=prev title="A Guide on Running Alpine Linux in QEMU"><i class="fas fa-angle-left fa-fw"></i>A Guide on Running Alpine Linux in QEMU</a>
<a href=/posts/debugging-the-linux-kernel-with-qemu-and-gdb/ class=next rel=next title="Debugging the Linux Kernel with QEMU and GDB">Debugging the Linux Kernel with QEMU and GDB<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=utterances></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>Utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.113.0">Hugo</a>&nbsp;|&nbsp;Theme - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.3.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer">yuankun</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{utterances:{darkTheme:"github-dark",issueTerm:"pathname",label:"comment",lightTheme:"github-light",repo:"yuankunzhang/blog"}}}</script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript src=/js/utterances.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZXQSK4ST20")</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-ZXQSK4ST20" async></script></div></body></html>