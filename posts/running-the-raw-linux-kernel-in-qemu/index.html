<!doctype html><html lang=en><head><title>Running the Raw Linux Kernel in QEMU · yuankun@net: ~$</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Yuankun Zhang"><meta name=description content="In the previous post we learned how to run a packaged Linux distribution in QEMU. This time, let&rsquo;s explore running a raw Linux kernel in QEMU."><meta name=keywords content="code,read,life"><meta name=twitter:card content="summary"><meta name=twitter:title content="Running the Raw Linux Kernel in QEMU"><meta name=twitter:description content="In the previous post we learned how to run a packaged Linux distribution in QEMU. This time, let&rsquo;s explore running a raw Linux kernel in QEMU."><meta property="og:title" content="Running the Raw Linux Kernel in QEMU"><meta property="og:description" content="In the previous post we learned how to run a packaged Linux distribution in QEMU. This time, let&rsquo;s explore running a raw Linux kernel in QEMU."><meta property="og:type" content="article"><meta property="og:url" content="https://yuankun.me/posts/running-the-raw-linux-kernel-in-qemu/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-03-16T22:50:52+08:00"><meta property="article:modified_time" content="2020-03-16T22:50:52+08:00"><link rel=canonical href=https://yuankun.me/posts/running-the-raw-linux-kernel-in-qemu/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.85656f585fe601450b123ec7c9a997f8488faf7f9e2c81913580c9e2f8c72f82.css integrity="sha256-hWVvWF/mAUULEj7HyamX+EiPr3+eLIGRNYDJ4vjHL4I=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.75de71d89fefe379cc001b6f6435f9b06dad86408428254718b48a73ea6d9e5e.css integrity="sha256-dd5x2J/v43nMABtvZDX5sG2thkCEKCVHGLSKc+ptnl4=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/img/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>yuankun@net: ~$</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://yuankun.me/posts/running-the-raw-linux-kernel-in-qemu/>Running the Raw Linux Kernel in QEMU</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2020-03-16T22:50:52+08:00>March 16, 2020</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
4-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/linux/>linux</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/qemu/>qemu</a></span></div></div></header><div class=post-content><p>In the <a href=/posts/a-guide-on-running-alpine-linux-in-qemu/>previous post</a> we learned how to run a packaged Linux distribution in QEMU. This time, let&rsquo;s explore running a raw Linux kernel in QEMU.</p><h2 id=a-brief-introduction-to-initial-ramdisk>A Brief Introduction to Initial Ramdisk
<a class=heading-link href=#a-brief-introduction-to-initial-ramdisk><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Many Linux distributions ship a small, generic kernel image. The device drivers are included as loadable kernel modules and stored in file system, it is just not practical to include all the device drivers in the kernel image itself. On my machine, the size of <code>vmlinuz-linux</code> is only 6.3 megabytes:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ ls -lh /boot/vmlinuz-linux
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#a5d6ff>1</span> root root 6.3M Mar <span style=color:#a5d6ff>15</span> 21:30 /boot/vmlinuz-linux
</span></span></code></pre></div><p>This presents a challenge of detecting and loading the necessary modules to mount the root file system during boot time. It&rsquo;s a chicken-and-egg problem. Additionally, the root file system may require special preparations to mount, such as being on an encrypted partition.</p><p>To address these challenges, the initial ramdisk comes into play as a temporary, RAM-based root file system. It contains user-space utilities that detect hardwares, descover devices, load necessary modules, and mount the actual root file system. Once it is loaded into memory, a simple yet sufficient environment is set up for the Linux kernel to complete the boot process. This environment is often called &ldquo;early user space&rdquo;.</p><p>On my machine, the initial ramdisk image is located in the boot partition with the name <code>initramfs-linux.img</code>. Not surprisingly, it is larger than the Linux kernel image itself:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ ls -lh /boot/initramfs-linux.img
</span></span><span style=display:flex><span>-rw-r--r-- <span style=color:#a5d6ff>1</span> root root 9.4M Mar <span style=color:#a5d6ff>15</span> 21:30 /boot/initramfs-linux.img
</span></span></code></pre></div><p>We can examine the contents of the image by using command <code>lsinitcpio /boot/initramfs-linux.img</code>. Indeed, it contains a simplified root system with various helper tools:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ lsinitcpio /boot/initramfs-linux.img
</span></span><span style=display:flex><span>bin
</span></span><span style=display:flex><span>buildconfig
</span></span><span style=display:flex><span>config
</span></span><span style=display:flex><span>dev/
</span></span><span style=display:flex><span>etc/
</span></span><span style=display:flex><span>etc/fstab
</span></span><span style=display:flex><span>etc/initrd-release
</span></span><span style=display:flex><span>etc/ld.so.cache
</span></span><span style=display:flex><span>etc/ld.so.conf
</span></span><span style=display:flex><span>etc/modprobe.d/
</span></span><span style=display:flex><span>etc/mtab
</span></span><span style=display:flex><span>hooks/
</span></span><span style=display:flex><span>hooks/udev
</span></span><span style=display:flex><span>init
</span></span><span style=display:flex><span>init_functions
</span></span><span style=display:flex><span>lib
</span></span><span style=display:flex><span>lib64
</span></span><span style=display:flex><span>new_root/
</span></span><span style=display:flex><span>proc/
</span></span><span style=display:flex><span>run/
</span></span><span style=display:flex><span>sbin
</span></span><span style=display:flex><span>sys/
</span></span><span style=display:flex><span>tmp/
</span></span><span style=display:flex><span>usr/
</span></span><span style=display:flex><span>usr/bin/
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>var/
</span></span><span style=display:flex><span>var/run
</span></span><span style=display:flex><span>VERSION
</span></span></code></pre></div><h2 id=creating-an-initial-ramdisk>Creating an Initial Ramdisk
<a class=heading-link href=#creating-an-initial-ramdisk><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>The command to create an initial ramdisk in Arch Linux <code>mkinitcpio</code>, but it may defer in other distributions.</p><p>Quoting from the <code>mkinitcpio</code> manual page:</p><blockquote><p>(mkinitcpio) creates an initial ramdisk environment for booting the Linux kernel. The initial ramdisk is in essence a very small environment (early userspace) which loads various kernel modules and sets up necessary things before handing over control to init. This makes it possible to have, for example, encrypted root filesystems and root filesystems on a software RAID array. mkinitcpio allows for easy extension with custom hooks, has autodetection at runtime, and many other features.</p></blockquote><p>Let&rsquo;s proceed with creating the initial ramdisk.</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ mkinitcpio -g initramfs.img
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>==</span>&gt; Starting build: 5.5.9-arch1-2
</span></span><span style=display:flex><span>  -&gt; Running build hook: <span style=color:#ff7b72;font-weight:700>[</span>base<span style=color:#ff7b72;font-weight:700>]</span>
</span></span><span style=display:flex><span>  -&gt; Running build hook: <span style=color:#ff7b72;font-weight:700>[</span>udev<span style=color:#ff7b72;font-weight:700>]</span>
</span></span><span style=display:flex><span>  -&gt; Running build hook: <span style=color:#ff7b72;font-weight:700>[</span>autodetect<span style=color:#ff7b72;font-weight:700>]</span>
</span></span><span style=display:flex><span>  -&gt; Running build hook: <span style=color:#ff7b72;font-weight:700>[</span>modconf<span style=color:#ff7b72;font-weight:700>]</span>
</span></span><span style=display:flex><span>  -&gt; Running build hook: <span style=color:#ff7b72;font-weight:700>[</span>block<span style=color:#ff7b72;font-weight:700>]</span>
</span></span><span style=display:flex><span>  -&gt; Running build hook: <span style=color:#ff7b72;font-weight:700>[</span>filesystems<span style=color:#ff7b72;font-weight:700>]</span>
</span></span><span style=display:flex><span>  -&gt; Running build hook: <span style=color:#ff7b72;font-weight:700>[</span>keyboard<span style=color:#ff7b72;font-weight:700>]</span>
</span></span><span style=display:flex><span>  -&gt; Running build hook: <span style=color:#ff7b72;font-weight:700>[</span>fsck<span style=color:#ff7b72;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>==</span>&gt; Generating module <span style=color:#79c0ff>dependencies</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>==</span>&gt; Creating gzip-compressed initcpio image: /home/yuankun/qemu-test/initramfs.img
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>==</span>&gt; Image generation successful
</span></span></code></pre></div><h2 id=configuring-and-building-the-linux-kernel>Configuring and Building the Linux Kernel
<a class=heading-link href=#configuring-and-building-the-linux-kernel><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Clone the Linux source code, and configure the Linux kernel with <code>make ARCH=x86_64 menuconfig</code>.</p><p><img src=/img/linux-menuconfig.png alt=Menuconfig></p><p>Save the configurations and exit the configuration interface, now let&rsquo;s compile the kernel image. The compiled kernel image will be located at <code>arch/x86/boot/bzImage</code>.</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ make -j<span style=color:#a5d6ff>`</span>nproc<span style=color:#a5d6ff>`</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>Setup is <span style=color:#a5d6ff>13820</span> bytes <span style=color:#ff7b72;font-weight:700>(</span>padded to <span style=color:#a5d6ff>13824</span> bytes<span style=color:#ff7b72;font-weight:700>)</span>.
</span></span><span style=display:flex><span>System is <span style=color:#a5d6ff>8801</span> kB
</span></span><span style=display:flex><span>CRC 52c54fbc
</span></span><span style=display:flex><span>Kernel: arch/x86/boot/bzImage is ready  <span style=color:#ff7b72;font-weight:700>(</span><span style=color:#8b949e;font-style:italic>#2)</span>
</span></span></code></pre></div><h2 id=booting-the-linux-kernel-in-qemu>Booting the Linux Kernel in QEMU
<a class=heading-link href=#booting-the-linux-kernel-in-qemu><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>Now that we have both the Kernel image and the initial ramdisk, it&rsquo;s time to boot the Linux kernel in QEMU.</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ qemu-system-x86_64 <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    -enable-kvm <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    -kernel bzImage <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    -smp <span style=color:#79c0ff>cores</span><span style=color:#ff7b72;font-weight:700>=</span>1,threads<span style=color:#ff7b72;font-weight:700>=</span><span style=color:#a5d6ff>2</span> <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    -m <span style=color:#a5d6ff>1024</span> <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    -append <span style=color:#a5d6ff>&#34;console=ttyS0&#34;</span> <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    -initrd initramfs.img <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    -serial stdio <span style=color:#79c0ff>\
</span></span></span><span style=display:flex><span><span style=color:#79c0ff></span>    -display none
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>    0.000000<span style=color:#ff7b72;font-weight:700>]</span> Linux version 5.6.0-rc6+ <span style=color:#ff7b72;font-weight:700>(</span>yuankun@mars<span style=color:#ff7b72;font-weight:700>)</span> <span style=color:#ff7b72;font-weight:700>(</span>gcc version 9.3.0 <span style=color:#ff7b72;font-weight:700>(</span>Arch Linux 9.3.0-1<span style=color:#ff7b72;font-weight:700>))</span> <span style=color:#8b949e;font-style:italic>#2 SMP Tue Mar 17 17:42:13 +08 2020</span>
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>    0.000000<span style=color:#ff7b72;font-weight:700>]</span> Command line: <span style=color:#79c0ff>console</span><span style=color:#ff7b72;font-weight:700>=</span>ttyS0
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>    0.000000<span style=color:#ff7b72;font-weight:700>]</span> x86/fpu: x87 FPU will use FXSAVE
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>    0.000000<span style=color:#ff7b72;font-weight:700>]</span> BIOS-provided physical RAM map:
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>    0.000000<span style=color:#ff7b72;font-weight:700>]</span> BIOS-e820: <span style=color:#ff7b72;font-weight:700>[</span>mem 0x0000000000000000-0x000000000009fbff<span style=color:#ff7b72;font-weight:700>]</span> usable
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>    0.000000<span style=color:#ff7b72;font-weight:700>]</span> BIOS-e820: <span style=color:#ff7b72;font-weight:700>[</span>mem 0x000000000009fc00-0x000000000009ffff<span style=color:#ff7b72;font-weight:700>]</span> reserved
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>    0.000000<span style=color:#ff7b72;font-weight:700>]</span> BIOS-e820: <span style=color:#ff7b72;font-weight:700>[</span>mem 0x00000000000f0000-0x00000000000fffff<span style=color:#ff7b72;font-weight:700>]</span> reserved
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>    0.000000<span style=color:#ff7b72;font-weight:700>]</span> BIOS-e820: <span style=color:#ff7b72;font-weight:700>[</span>mem 0x0000000000100000-0x000000007ffdffff<span style=color:#ff7b72;font-weight:700>]</span> usable
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>    0.000000<span style=color:#ff7b72;font-weight:700>]</span> BIOS-e820: <span style=color:#ff7b72;font-weight:700>[</span>mem 0x000000007ffe0000-0x000000007fffffff<span style=color:#ff7b72;font-weight:700>]</span> reserved
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>    0.000000<span style=color:#ff7b72;font-weight:700>]</span> BIOS-e820: <span style=color:#ff7b72;font-weight:700>[</span>mem 0x00000000feffc000-0x00000000feffffff<span style=color:#ff7b72;font-weight:700>]</span> reserved
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>    0.000000<span style=color:#ff7b72;font-weight:700>]</span> BIOS-e820: <span style=color:#ff7b72;font-weight:700>[</span>mem 0x00000000fffc0000-0x00000000ffffffff<span style=color:#ff7b72;font-weight:700>]</span> reserved
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>    0.000000<span style=color:#ff7b72;font-weight:700>]</span> NX <span style=color:#ff7b72;font-weight:700>(</span>Execute Disable<span style=color:#ff7b72;font-weight:700>)</span> protection: active
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>    0.000000<span style=color:#ff7b72;font-weight:700>]</span> SMBIOS 2.8 present.
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#ff7b72;font-weight:700>[</span>rootfs <span style=color:#ff7b72;font-weight:700>]</span><span style=color:#8b949e;font-style:italic>#</span>
</span></span></code></pre></div><p>You will soon see the <code>[rootfs] #</code> prompt, indicating that we are now in the environment provided by the initial ramdisk. Cheers!</p></div><footer><div class=comments><script>let getTheme=window.localStorage&&window.localStorage.getItem("colorscheme");getTheme=getTheme??"github-light";let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","yuankunzhang/blog"),s.setAttribute("issue-term","pathname"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></footer></article></section></div><footer class=footer><section class=container>©
2019 -
2023
Yuankun Zhang
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>