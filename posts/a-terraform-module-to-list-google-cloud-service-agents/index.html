<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>A Terraform Module to List Google Cloud Service Agents - yuankun@net: ~$</title><meta name=Description content="Always do what you're afraid to do"><meta property="og:title" content="A Terraform Module to List Google Cloud Service Agents"><meta property="og:description" content="Google Cloud Platform presents two distinct types of service accounts: user-managed service accounts and Google-managed service accounts. The former is typically employed by user applications as an interface with Google Cloud, whereas the latter is utilized internally by Google Cloud. Within the realm of Google-managed service accounts, a specialized subset exists: Google Cloud Service Agents. These service agents are used by Google Cloud services to operate internal processes necessary to fulfill user-requested operations.
A service agent adhers to the following template:
service-PROJECT_NUMBER@SERVICE_NAME.iam.gserviceaccount.com
These service agents are easily identifiable within the IAM section of the Google Cloud Console.

        
    
During the management of IAM binding policies via Terraform, these service agents can often become obtrusive. For illustration, consider the following code snippet from one of our Terraform files (where xxxxx substitutes the actual project number)."><meta property="og:type" content="article"><meta property="og:url" content="https://yuankun.me/posts/a-terraform-module-to-list-google-cloud-service-agents/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-01T23:47:03+08:00"><meta property="article:modified_time" content="2020-04-01T23:47:03+08:00"><meta property="og:site_name" content="yuankun@net: ~$"><meta name=twitter:card content="summary"><meta name=twitter:title content="A Terraform Module to List Google Cloud Service Agents"><meta name=twitter:description content="Google Cloud Platform presents two distinct types of service accounts: user-managed service accounts and Google-managed service accounts. The former is typically employed by user applications as an interface with Google Cloud, whereas the latter is utilized internally by Google Cloud. Within the realm of Google-managed service accounts, a specialized subset exists: Google Cloud Service Agents. These service agents are used by Google Cloud services to operate internal processes necessary to fulfill user-requested operations.
A service agent adhers to the following template:
service-PROJECT_NUMBER@SERVICE_NAME.iam.gserviceaccount.com
These service agents are easily identifiable within the IAM section of the Google Cloud Console.

        
    
During the management of IAM binding policies via Terraform, these service agents can often become obtrusive. For illustration, consider the following code snippet from one of our Terraform files (where xxxxx substitutes the actual project number)."><meta name=application-name content="yuankun@net: ~$"><meta name=apple-mobile-web-app-title content="yuankun@net: ~$"><meta name=theme-color content="#f8f8f8"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=canonical href=https://yuankun.me/posts/a-terraform-module-to-list-google-cloud-service-agents/><link rel=prev href=https://yuankun.me/posts/debugging-the-linux-kernel-with-qemu-and-gdb/><link rel=next href=https://yuankun.me/posts/smallest-root-filesystem-for-linux/><link rel=stylesheet href=/css/main.css><link rel=stylesheet href=/lib/normalize/normalize.min.css><link rel=stylesheet href=/css/color.css><link rel=stylesheet href=/css/style.min.css><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/fontawesome-free/all.min.css><noscript><link rel=stylesheet href=/lib/fontawesome-free/all.min.css></noscript><link rel=preload as=style onload='this.onload=null,this.rel="stylesheet"' href=/lib/animate/animate.min.css><noscript><link rel=stylesheet href=/lib/animate/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"A Terraform Module to List Google Cloud Service Agents","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/yuankun.me\/posts\/a-terraform-module-to-list-google-cloud-service-agents\/"},"genre":"posts","keywords":"gcp, terraform","wordcount":289,"url":"https:\/\/yuankun.me\/posts\/a-terraform-module-to-list-google-cloud-service-agents\/","datePublished":"2020-04-01T23:47:03+08:00","dateModified":"2020-04-01T23:47:03+08:00","publisher":{"@type":"Organization","name":"yuankun"},"author":{"@type":"Person","name":"yuankun"},"description":""}</script><script src=//instant.page/5.2.0 defer type=module integrity=sha384-jnZyxPjiipYXnSU0ygqeac2q7CVYMbh84q0uHVRRxEtvFPiQYbXWUorga2aqZJ0z></script></head><body header-desktop header-mobile><script type=text/javascript>function setTheme(e){document.body.setAttribute("theme",e),document.documentElement.style.setProperty("color-scheme",e==="light"?"light":"dark"),window.theme=e,window.isDark=window.theme!=="light"}function saveTheme(e){window.localStorage&&localStorage.setItem("theme",e)}function getMeta(e){const t=document.getElementsByTagName("meta");for(let n=0;n<t.length;n++)if(t[n].getAttribute("name")===e)return t[n];return""}if(window.localStorage&&localStorage.getItem("theme")){let e=localStorage.getItem("theme");e==="light"||e==="dark"||e==="black"?setTheme(e):setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")}else""==="light"||""==="dark"||""==="black"?(setTheme(""),saveTheme("")):(saveTheme("auto"),setTheme(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"));let metaColors={light:"#f8f8f8",dark:"#252627",black:"#000000"};getMeta("theme-color").content=metaColors[document.body.getAttribute("theme")],window.switchThemeEventSet=new Set</script><div id=back-to-top></div><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="yuankun@net: ~$">yuankun@net: ~$</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Blog </a><a class=menu-item href=/about/>About </a><a class=menu-item href=/syscall64/>Linux Syscalls </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="yuankun@net: ~$">yuankun@net: ~$</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Blog</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=/syscall64/ title>Linux Syscalls</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC","false")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">A Terraform Module to List Google Cloud Service Agents</h1><div class=post-meta><div class=post-meta-line><span class=post-author><span class="author fas fa-user-circle fa-fw"></span><a href=/ title=Author rel=author class=author>yuankun</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2020-04-01>2020-04-01</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime=2020-04-01>2020-04-01</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;289 words&nbsp;
<i class="far fa-clock fa-fw"></i>&nbsp;2 minutes&nbsp;</div></div><div class=content id=content><p>Google Cloud Platform presents <a href=https://cloud.google.com/iam/docs/service-accounts#types_of_service_accounts target=_blank rel="noopener noreferrer">two distinct types of service accounts</a>: user-managed service accounts and Google-managed service accounts. The former is typically employed by user applications as an interface with Google Cloud, whereas the latter is utilized internally by Google Cloud. Within the realm of Google-managed service accounts, a specialized subset exists: Google Cloud Service Agents. These service agents are used by Google Cloud services to operate internal processes necessary to fulfill user-requested operations.</p><p>A service agent adhers to the following template:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>service-PROJECT_NUMBER@SERVICE_NAME.iam.gserviceaccount.com
</span></span></code></pre></div><p>These service agents are easily identifiable within the IAM section of the Google Cloud Console.</p><p><figure><a class=lightgallery href=/img/20200402-0012.png title="Service Agents" data-thumbnail=/img/20200402-0012.png><img loading=lazy src=/img/20200402-0012.png srcset="/img/20200402-0012.png, /img/20200402-0012.png 1.5x, /img/20200402-0012.png 2x" sizes=auto alt=/img/20200402-0012.png></a></figure></p><p>During the management of IAM binding policies via Terraform, these service agents can often become obtrusive. For illustration, consider the following code snippet from one of our Terraform files (where <code>xxxxx</code> substitutes the actual project number).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>data</span> <span class=s2>&#34;google_project&#34; &#34;project&#34;</span> {}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;google_project_iam_binding&#34; &#34;cloudbuild_service_agent&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  project</span> <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>google_project</span><span class=p>.</span><span class=k>project</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=cl><span class=n>  role</span>    <span class=o>=</span> <span class=s2>&#34;roles/cloudbuild.serviceAgent&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  members</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;serviceAccount:service-xxxxx@gcp-sa-cloudbuild.iam.gserviceaccount.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;google_project_iam_binding&#34; &#34;container_service_agent&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  project</span> <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>google_project</span><span class=p>.</span><span class=k>project</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=cl><span class=n>  role</span>    <span class=o>=</span> <span class=s2>&#34;roles/container.serviceAgent&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  members</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;serviceAccount:service-xxxxx@container-engine-robot.iam.gserviceaccount.com&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>The complication intensifies when referencing service agents from different projects, as these project numbers can often resemble what we term &ldquo;magic numbers&rdquo;.</p><p>To address this issue, I&rsquo;ve developed a simple Terraform module dubbed <a href=https://github.com/yuankunzhang/google-cloud-service-agents target=_blank rel="noopener noreferrer">google-cloud-service-agents</a>. This module accepts a project ID as input and provides a list of service agents as output. By leveraging this module, the aforementioned code snippet can be effectively refactored as follow:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>data</span> <span class=s2>&#34;google_project&#34; &#34;project&#34;</span> {}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>module</span> <span class=s2>&#34;agents&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  source</span> <span class=o>=</span> <span class=s2>&#34;/path/to/module&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  project_number</span> <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>google_project</span><span class=p>.</span><span class=k>project</span><span class=p>.</span><span class=k>number</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;google_project_iam_binding&#34; &#34;cloudbuild_service_agent&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  project</span> <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>google_project</span><span class=p>.</span><span class=k>project</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=cl><span class=n>  role</span>    <span class=o>=</span> <span class=s2>&#34;roles/cloudbuild.serviceAgent&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  members</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;serviceAccount:${module.agents.cloud_build}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;google_project_iam_binding&#34; &#34;container_service_agent&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  project</span> <span class=o>=</span> <span class=k>data</span><span class=p>.</span><span class=k>google_project</span><span class=p>.</span><span class=k>project</span><span class=p>.</span><span class=k>project_id</span>
</span></span><span class=line><span class=cl><span class=n>  role</span>    <span class=o>=</span> <span class=s2>&#34;roles/container.serviceAgent&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>  members</span> <span class=o>=</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;serviceAccount:${module.agents.container_engine}&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>For more information, kindly refer to the <a href=https://github.com/yuankunzhang/google-cloud-service-agents target=_blank rel="noopener noreferrer">Github repository</a>.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2020-04-01</span></div><div class=post-info-license></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/gcp/>gcp</a>,&nbsp;<a href=/tags/terraform/>terraform</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/debugging-the-linux-kernel-with-qemu-and-gdb/ class=prev rel=prev title="Debugging the Linux Kernel with QEMU and GDB"><i class="fas fa-angle-left fa-fw"></i>Debugging the Linux Kernel with QEMU and GDB</a>
<a href=/posts/smallest-root-filesystem-for-linux/ class=next rel=next title="Smallest Root Filesystem for Linux">Smallest Root Filesystem for Linux<i class="fas fa-angle-right fa-fw"></i></a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Powered by <a href=https://gohugo.io/ target=_blank rel="noopener noreferrer" title="Hugo 0.112.7">Hugo</a>&nbsp;|&nbsp;Theme - <a href=https://github.com/HEIGE-PCloud/DoIt target=_blank rel="noopener noreferrer" title="DoIt 0.3.0"><i class="far fa-edit fa-fw"></i> DoIt</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank rel="noopener noreferrer">yuankun</a></span></div><div class=footer-line></div><div class=footer-line></div></div></footer></div><div id=fixed-buttons><a href=#back-to-top id=back-to-top-button class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw"></i></a></div><div class=assets><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:10},comment:{}}</script><script type=text/javascript src=/lib/clipboard/clipboard.min.js></script><script type=text/javascript src=/js/theme.min.js defer></script><script type=text/javascript>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZXQSK4ST20")</script><script type=text/javascript src="https://www.googletagmanager.com/gtag/js?id=G-ZXQSK4ST20" async></script></div></body></html>