<!doctype html><html lang=en><head><title>A Terraform Module to List Google Cloud Service Agents · yuankun@net $</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Yuankun Zhang"><meta name=description content="There are two types of service accounts in Google Cloud: user-managed service accounts, which are used by user applications to talk to Google Cloud; and Google-managed services accounts, which are used by Google Cloud internally. Among the second category, there is a special subtype of service accounts called Google Cloud Service Agents. Service Agents are used by Google Cloud services to run internal processes so that user requested operations can be fulfilled.
A service agent has the following pattern:
service-PROJECT_NUMBER@SERVICE_NAME.iam.gserviceaccount.com
You can spot the service agents from the IAM section of Google Cloud Console.

When managing IAM binding policies via Terraform, these service agents often generate noises. As an example, I&rsquo;ll show you a code snippet coming from one of our Terraform files (I&rsquo;m using xxxxx instead of the real project number)."><meta name=keywords content="code,read,life"><meta name=twitter:card content="summary"><meta name=twitter:title content="A Terraform Module to List Google Cloud Service Agents"><meta name=twitter:description content="There are two types of service accounts in Google Cloud: user-managed service accounts, which are used by user applications to talk to Google Cloud; and Google-managed services accounts, which are used by Google Cloud internally. Among the second category, there is a special subtype of service accounts called Google Cloud Service Agents. Service Agents are used by Google Cloud services to run internal processes so that user requested operations can be fulfilled.
A service agent has the following pattern:
service-PROJECT_NUMBER@SERVICE_NAME.iam.gserviceaccount.com
You can spot the service agents from the IAM section of Google Cloud Console.

When managing IAM binding policies via Terraform, these service agents often generate noises. As an example, I&rsquo;ll show you a code snippet coming from one of our Terraform files (I&rsquo;m using xxxxx instead of the real project number)."><meta property="og:title" content="A Terraform Module to List Google Cloud Service Agents"><meta property="og:description" content="There are two types of service accounts in Google Cloud: user-managed service accounts, which are used by user applications to talk to Google Cloud; and Google-managed services accounts, which are used by Google Cloud internally. Among the second category, there is a special subtype of service accounts called Google Cloud Service Agents. Service Agents are used by Google Cloud services to run internal processes so that user requested operations can be fulfilled.
A service agent has the following pattern:
service-PROJECT_NUMBER@SERVICE_NAME.iam.gserviceaccount.com
You can spot the service agents from the IAM section of Google Cloud Console.

When managing IAM binding policies via Terraform, these service agents often generate noises. As an example, I&rsquo;ll show you a code snippet coming from one of our Terraform files (I&rsquo;m using xxxxx instead of the real project number)."><meta property="og:type" content="article"><meta property="og:url" content="https://yuankun.me/posts/a-terraform-module-to-list-google-cloud-service-agents/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-04-01T23:47:03+08:00"><meta property="article:modified_time" content="2020-04-01T23:47:03+08:00"><link rel=canonical href=https://yuankun.me/posts/a-terraform-module-to-list-google-cloud-service-agents/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.85656f585fe601450b123ec7c9a997f8488faf7f9e2c81913580c9e2f8c72f82.css integrity="sha256-hWVvWF/mAUULEj7HyamX+EiPr3+eLIGRNYDJ4vjHL4I=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.75de71d89fefe379cc001b6f6435f9b06dad86408428254718b48a73ea6d9e5e.css integrity="sha256-dd5x2J/v43nMABtvZDX5sG2thkCEKCVHGLSKc+ptnl4=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/img/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/img/favicon-16x16.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>yuankun@net $</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://yuankun.me/posts/a-terraform-module-to-list-google-cloud-service-agents/>A Terraform Module to List Google Cloud Service Agents</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2020-04-01T23:47:03+08:00>April 1, 2020</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
2-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/gcp/>gcp</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/terraform/>terraform</a></span></div></div></header><div class=post-content><p>There are <a href=https://cloud.google.com/iam/docs/service-accounts#types_of_service_accounts class=external-link target=_blank rel=noopener>two types of service accounts</a> in Google Cloud: user-managed service accounts, which are used by user applications to talk to Google Cloud; and Google-managed services accounts, which are used by Google Cloud internally. Among the second category, there is a special subtype of service accounts called Google Cloud Service Agents. Service Agents are used by Google Cloud services to run internal processes so that user requested operations can be fulfilled.</p><p>A service agent has the following pattern:</p><pre tabindex=0><code>service-PROJECT_NUMBER@SERVICE_NAME.iam.gserviceaccount.com
</code></pre><p>You can spot the service agents from the IAM section of Google Cloud Console.</p><p><img src=/img/20200402-0012.png alt="Service Agents"></p><p>When managing IAM binding policies via Terraform, these service agents often generate noises. As an example, I&rsquo;ll show you a code snippet coming from one of our Terraform files (I&rsquo;m using <code>xxxxx</code> instead of the real project number).</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#ff7b72>data</span> <span style=color:#a5d6ff>&#34;google_project&#34; &#34;project&#34;</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>resource</span> <span style=color:#a5d6ff>&#34;google_project_iam_binding&#34; &#34;cloudbuild_service_agent&#34;</span> {
</span></span><span style=display:flex><span>  project <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>data</span>.<span style=color:#ff7b72>google_project</span>.<span style=color:#ff7b72>project</span>.<span style=color:#ff7b72>project_id</span>
</span></span><span style=display:flex><span>  role    <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;roles/cloudbuild.serviceAgent&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  members <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;serviceAccount:service-xxxxx@gcp-sa-cloudbuild.iam.gserviceaccount.com&#34;</span>,
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>resource</span> <span style=color:#a5d6ff>&#34;google_project_iam_binding&#34; &#34;container_service_agent&#34;</span> {
</span></span><span style=display:flex><span>  project <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>data</span>.<span style=color:#ff7b72>google_project</span>.<span style=color:#ff7b72>project</span>.<span style=color:#ff7b72>project_id</span>
</span></span><span style=display:flex><span>  role    <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;roles/container.serviceAgent&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  members <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;serviceAccount:service-xxxxx@container-engine-robot.iam.gserviceaccount.com&#34;</span>,
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>When you are refering to service agents from other projects, things get even worse. Those project numbers look very much lick what we call &ldquo;the magic number&rdquo;.</p><p>To tackle this, I wrote a simple Terraform module named <a href=https://github.com/yuankunzhang/google-cloud-service-agents class=external-link target=_blank rel=noopener>google-cloud-service-agents</a>. It consumes a project ID and exposes a list of service agents. With this module, the above code snippet can be rewritten to this:</p><div class=highlight><pre tabindex=0 style=color:#c9d1d9;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#ff7b72>data</span> <span style=color:#a5d6ff>&#34;google_project&#34; &#34;project&#34;</span> {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>module</span> <span style=color:#a5d6ff>&#34;agents&#34;</span> {
</span></span><span style=display:flex><span>  source <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;/path/to/module&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  project_number <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>data</span>.<span style=color:#ff7b72>google_project</span>.<span style=color:#ff7b72>project</span>.<span style=color:#ff7b72>number</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>resource</span> <span style=color:#a5d6ff>&#34;google_project_iam_binding&#34; &#34;cloudbuild_service_agent&#34;</span> {
</span></span><span style=display:flex><span>  project <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>data</span>.<span style=color:#ff7b72>google_project</span>.<span style=color:#ff7b72>project</span>.<span style=color:#ff7b72>project_id</span>
</span></span><span style=display:flex><span>  role    <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;roles/cloudbuild.serviceAgent&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  members <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;serviceAccount:${module.agents.cloud_build}&#34;</span>,
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>resource</span> <span style=color:#a5d6ff>&#34;google_project_iam_binding&#34; &#34;container_service_agent&#34;</span> {
</span></span><span style=display:flex><span>  project <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>data</span>.<span style=color:#ff7b72>google_project</span>.<span style=color:#ff7b72>project</span>.<span style=color:#ff7b72>project_id</span>
</span></span><span style=display:flex><span>  role    <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#a5d6ff>&#34;roles/container.serviceAgent&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  members <span style=color:#ff7b72;font-weight:700>=</span> [
</span></span><span style=display:flex><span>    <span style=color:#a5d6ff>&#34;serviceAccount:${module.agents.container_engine}&#34;</span>,
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>For more information, please check out the <a href=https://github.com/yuankunzhang/google-cloud-service-agents class=external-link target=_blank rel=noopener>Github repository</a>.</p></div><footer><div class=comments><script>let getTheme=window.localStorage&&window.localStorage.getItem("colorscheme");getTheme=getTheme??"github-light";let theme=getTheme==="dark"?"github-dark":"github-light",s=document.createElement("script");s.src="https://utteranc.es/client.js",s.setAttribute("repo","yuankunzhang/blog"),s.setAttribute("issue-term","pathname"),s.setAttribute("theme",theme),s.setAttribute("crossorigin","anonymous"),s.setAttribute("async",""),document.querySelector("div.comments").innerHTML="",document.querySelector("div.comments").appendChild(s)</script></div></footer></article></section></div><footer class=footer><section class=container>©
2019 -
2023
Yuankun Zhang
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script></body></html>