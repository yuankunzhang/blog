<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title>gcp on Yuankun&#39;s Blog</title>
		<link>https://yuankun.me/tags/gcp/</link>
		<description>Recent content in gcp on Yuankun&#39;s Blog</description>
		<generator>Hugo 0.80.0 -- gohugo.io</generator>
		<language>en-us</language>
		<lastBuildDate>Wed, 01 Apr 2020 23:47:03 +0800</lastBuildDate>
		<atom:link href="https://yuankun.me/tags/gcp/index.xml" rel="self" type="application/rss+xml" />
		<item>
			<title>A Terraform Module to List Google Cloud Service Agents</title>
			<link>https://yuankun.me/posts/a-terraform-module-to-list-google-cloud-service-agents/</link>
			<pubDate>Wed, 01 Apr 2020 23:47:03 +0800</pubDate>
			<guid isPermaLink="true">https://yuankun.me/posts/a-terraform-module-to-list-google-cloud-service-agents/</guid>
			<description>&lt;p&gt;There are &lt;a href=&#34;https://cloud.google.com/iam/docs/service-accounts#types_of_service_accounts&#34;&gt;two types of service accounts&lt;/a&gt; in Google Cloud: user-managed service accounts, which are used by user applications to talk to Google Cloud; and Google-managed services accounts, which are used by Google Cloud internally. Among the second category, there is a special subtype of service accounts called Google Cloud Service Agents. Service Agents are used by Google Cloud services to run internal processes so that user requested operations can be fulfilled.&lt;/p&gt;
&lt;p&gt;A service agent has the following pattern:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;service-PROJECT_NUMBER@SERVICE_NAME.iam.gserviceaccount.com
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;You can spot the service agents from the IAM section of Google Cloud Console.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://yuankun.me/img/20200402-0012.png&#34; alt=&#34;Service Agents&#34;&gt;&lt;/p&gt;
&lt;p&gt;When managing IAM binding policies via Terraform, these service agents often generate noises. As an example, I&amp;rsquo;ll show you a code snippet coming from one of our Terraform files (I&amp;rsquo;m using &lt;code&gt;xxxxx&lt;/code&gt; instead of the real project number).&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-hcl&#34; data-lang=&#34;hcl&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;google_project&amp;#34; &amp;#34;project&amp;#34;&lt;/span&gt; {}

&lt;span style=&#34;color:#66d9ef&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;google_project_iam_binding&amp;#34; &amp;#34;cloudbuild_service_agent&amp;#34;&lt;/span&gt; {
  project &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;data&lt;/span&gt;.&lt;span style=&#34;color:#66d9ef&#34;&gt;google_project&lt;/span&gt;.&lt;span style=&#34;color:#66d9ef&#34;&gt;project&lt;/span&gt;.&lt;span style=&#34;color:#66d9ef&#34;&gt;project_id&lt;/span&gt;
  role    &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;roles/cloudbuild.serviceAgent&amp;#34;&lt;/span&gt;

  members &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;serviceAccount:service-xxxxx@gcp-sa-cloudbuild.iam.gserviceaccount.com&amp;#34;&lt;/span&gt;,
  ]
}

&lt;span style=&#34;color:#66d9ef&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;google_project_iam_binding&amp;#34; &amp;#34;container_service_agent&amp;#34;&lt;/span&gt; {
  project &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;data&lt;/span&gt;.&lt;span style=&#34;color:#66d9ef&#34;&gt;google_project&lt;/span&gt;.&lt;span style=&#34;color:#66d9ef&#34;&gt;project&lt;/span&gt;.&lt;span style=&#34;color:#66d9ef&#34;&gt;project_id&lt;/span&gt;
  role    &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;roles/container.serviceAgent&amp;#34;&lt;/span&gt;

  members &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;serviceAccount:service-xxxxx@container-engine-robot.iam.gserviceaccount.com&amp;#34;&lt;/span&gt;,
  ]
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;When you are refering to service agents from other projects, things get even worse. Those project numbers look very much lick what we call &amp;ldquo;the magic number&amp;rdquo;.&lt;/p&gt;
&lt;p&gt;To tackle this, I wrote a simple Terraform module named &lt;a href=&#34;https://github.com/yuankunzhang/google-cloud-service-agents&#34;&gt;google-cloud-service-agents&lt;/a&gt;. It consumes a project ID and exposes a list of service agents. With this module, the above code snippet can be rewritten to this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4&#34;&gt;&lt;code class=&#34;language-hcl&#34; data-lang=&#34;hcl&#34;&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;data&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;google_project&amp;#34; &amp;#34;project&amp;#34;&lt;/span&gt; {}

&lt;span style=&#34;color:#66d9ef&#34;&gt;module&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;agents&amp;#34;&lt;/span&gt; {
  source &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/path/to/module&amp;#34;&lt;/span&gt;

  project_number &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;data&lt;/span&gt;.&lt;span style=&#34;color:#66d9ef&#34;&gt;google_project&lt;/span&gt;.&lt;span style=&#34;color:#66d9ef&#34;&gt;project&lt;/span&gt;.&lt;span style=&#34;color:#66d9ef&#34;&gt;number&lt;/span&gt;
}

&lt;span style=&#34;color:#66d9ef&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;google_project_iam_binding&amp;#34; &amp;#34;cloudbuild_service_agent&amp;#34;&lt;/span&gt; {
  project &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;data&lt;/span&gt;.&lt;span style=&#34;color:#66d9ef&#34;&gt;google_project&lt;/span&gt;.&lt;span style=&#34;color:#66d9ef&#34;&gt;project&lt;/span&gt;.&lt;span style=&#34;color:#66d9ef&#34;&gt;project_id&lt;/span&gt;
  role    &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;roles/cloudbuild.serviceAgent&amp;#34;&lt;/span&gt;

  members &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;serviceAccount:${module.agents.cloud_build}&amp;#34;&lt;/span&gt;,
  ]
}

&lt;span style=&#34;color:#66d9ef&#34;&gt;resource&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;google_project_iam_binding&amp;#34; &amp;#34;container_service_agent&amp;#34;&lt;/span&gt; {
  project &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;data&lt;/span&gt;.&lt;span style=&#34;color:#66d9ef&#34;&gt;google_project&lt;/span&gt;.&lt;span style=&#34;color:#66d9ef&#34;&gt;project&lt;/span&gt;.&lt;span style=&#34;color:#66d9ef&#34;&gt;project_id&lt;/span&gt;
  role    &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;roles/container.serviceAgent&amp;#34;&lt;/span&gt;

  members &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [
    &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;serviceAccount:${module.agents.container_engine}&amp;#34;&lt;/span&gt;,
  ]
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;For more information, please check out the &lt;a href=&#34;https://github.com/yuankunzhang/google-cloud-service-agents&#34;&gt;Github repository&lt;/a&gt;.&lt;/p&gt;
</description>
		</item>
		<item>
			<title>GCP IPs All Appear in US, and It Is an Intended Behavior</title>
			<link>https://yuankun.me/posts/gcp-ips-all-appear-in-us-and-it-is-an-intended-behavior/</link>
			<pubDate>Sun, 22 Mar 2020 23:12:59 +0800</pubDate>
			<guid isPermaLink="true">https://yuankun.me/posts/gcp-ips-all-appear-in-us-and-it-is-an-intended-behavior/</guid>
			<description>&lt;p&gt;As you may have already known, all the IPs of Google Cloud Platform share the same geolocation, which is the US. This buggy thing has been marked as &amp;ldquo;intended behavior&amp;rdquo;, so no fix would be expected in the future. Even ironically, the guy who raised this issue was &amp;ldquo;kindly advised&amp;rdquo; to contact Google&amp;rsquo;s legal department. Here is the &lt;a href=&#34;https://issuetracker.google.com/issues/112448138&#34;&gt;issue ticket&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://yuankun.me/img/you-are-kindly-advised-to-contact-googles-legal-department.png&#34; alt=&#34;You are kindly advised to contact Google&amp;rsquo;s legal department&#34;&gt;&lt;/p&gt;
&lt;p&gt;Dear Google, when people create a network in a chosen region, they expect the public IPs of the network to be in that region. Let&amp;rsquo;s take the GDPR thing as an example. You set up a service in Europe region, but a geolocation lookup of the service IP shows it is in the US. Even though the service is indeed running in Europe region, you are gonna need some effort to convince your customers that there should be no trace that the data is going out of Europe.&lt;/p&gt;
&lt;p&gt;I can tell another issue caused by this &amp;ldquo;feature&amp;rdquo;. A few days ago, a friend of mine encountered a weird challenge. They have servers running on Google Cloud Platform in both Asia and North America, serving Asian and North American customers respectively. Recently they integrated a new third party service (let&amp;rsquo;s call it TPS) to their backend services. This TPS is claimed to have replicas running in both Asia and North America. So requests originating from Asia should be hitting the TPS replica in Asia, and requests originating from North America should be hitting the TPS replica in North America. Out of expectation, all requests were going to the TPS replica in North America. This adds about 200ms extra latency to every customer request!&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://yuankun.me/img/unexpected-traffic-routing.png&#34; alt=&#34;Unexpected traffic routing&#34;&gt;&lt;/p&gt;
&lt;p&gt;And there are other people facing the same issue.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://stackoverflow.com/questions/58108523/outgoing-http-request-location-on-google-app-engine&#34;&gt;This Stackoverflow user&lt;/a&gt; migrated his service from DigitalOcean to GCP and the service didn&amp;rsquo;t work healthily, because &amp;ldquo;a third-party API only accepts requests coming from Brazil&amp;rdquo;.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://stackoverflow.com/questions/51801691/created-gce-in-europe-region-but-ip-address-shows-its-in-us&#34;&gt;This Stackoverflow user&lt;/a&gt; gave up using GCP and turned to Azure, because &amp;ldquo;they have strict guideline not to transmit data out of Europe region and they couldn&amp;rsquo;t prove to customers that their service is actually in Europe not in US&amp;rdquo;.&lt;/p&gt;
&lt;p&gt;Nowadays lots of existing infrastructure (firewalls, CDNs, etc) and services rely on IP geolocation. The &amp;ldquo;all IPs sharing same geolocation feature&amp;rdquo; for sure fools them all.&lt;/p&gt;
&lt;p&gt;And I&amp;rsquo;m waiting for more victims.&lt;/p&gt;
</description>
		</item>
	</channel>
</rss>
